"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[40995],{751368:function(e,t,i){i.d(t,{R:function(){return r},s:function(){return s}});var a=i(812943);let r=!0,s=(e,t)=>{let i=e.root();e.getAreSocialIconsHidden=()=>e.config.isSocialIconsHidden,e.setAreSocialIconsHidden=t=>{e.config.isSocialIconsHidden=t,e.update()},e.getShouldPushMetaToAGOItemDetails=()=>!1===e.getGlobalStates().featureDecisions.canAccessPortalApp||(e.config.shouldPushMetaToAGOItemDetails??r),e.resetMetaSettings=async()=>{e.data.metaSettings&&(delete e.data.metaSettings,await t.onReset?.(),e.emitMetaSettingsUpdate(),await e.update())},e.emitMetaSettingsUpdate=t=>{let a=t??e.getMetaSettings();i.emit("meta-settings-update",a)},e.getMetaSettings=()=>{let i=t.getMetaThumbnail();return{title:e.data.metaSettings?.title,description:e.data.metaSettings?.description,thumbnail:i}},e.updateMetaSettings=async t=>{t.shouldPushMetaToAGOItemDetails!==e.config.shouldPushMetaToAGOItemDetails&&(e.config.shouldPushMetaToAGOItemDetails=t.shouldPushMetaToAGOItemDetails,e.states.hasShouldPushMetaToAGOItemDetailsChanged=!0);let i={title:t.metaSettings.title??e.data.metaSettings?.title,description:t.metaSettings.description??e.data.metaSettings?.description,thumbnail:t.metaSettings.thumbnail};e.emitMetaSettingsUpdate(i);let r={title:i.title,description:i.description,imageResourceId:e.data.metaSettings?.imageResourceId};if(t.metaThumbnailForUpload){let i;let{storyItem:s}=e.getGlobalStates();try{i=await (0,a.cT)({storyBuilder:s,data:t.metaThumbnailForUpload})}catch(t){e.getGlobalStates().toast.add({type:"error",title:e.getGlobalStates().getIntl().formatMessage({id:"builder.common.uploadError"})})}if(i){let t=await e.insertResource({data:{resourceId:i.resourceId,provider:"item-resource",type:"image",width:i.width,height:i.height},root:e,type:"image"});t&&(r.imageResourceId=t.id)}}e.data.metaSettings=r,await e.update()},e.getHaveMetaSettingsChanged=()=>void 0!==e.data.metaSettings?.title||void 0!==e.data.metaSettings?.description||void 0!==e.data.metaSettings?.imageResourceId,e.getMetaSettingsDataForSave=()=>{let t=e.root().do("getCoverData"),i=e.getShouldPushMetaToAGOItemDetails(),a={...i?{}:{title:t.title,description:t.snippet},...e.data.metaSettings};return a.imageResourceId&&delete a.imageResourceId,{shouldPushMetaToAGOItemDetails:i,hasShouldPushMetaToAGOItemDetailsChanged:e.states.hasShouldPushMetaToAGOItemDetailsChanged,properties:{metaProperties:a}}},i.addEventListener("getMetaSettings",e.getMetaSettings),i.addEventListener("updateMetaSettings",e.updateMetaSettings),i.addEventListener("getHaveMetaSettingsChanged",e.getHaveMetaSettingsChanged),i.addEventListener("resetMetaSettings",e.resetMetaSettings),i.addEventListener("getShouldPushMetaToAGOItemDetails",e.getShouldPushMetaToAGOItemDetails),i.addEventListener("isSocialIconsHidden",e.getAreSocialIconsHidden),i.addEventListener("updateSocialIconsHiddenStatus",e.setAreSocialIconsHidden)}},71635:function(e,t,i){i.d(t,{C_:function(){return o},EF:function(){return n},Th:function(){return c},Yq:function(){return d},jf:function(){return l},p5:function(){return u},xi:function(){return s}});var a=i(863982),r=i(453846);let s=e=>`media-provider-tab-${e}`,o=e=>`media-provider-${e}`,n=e=>{if("image"===e.type)switch(e.data.provider){case"unsplash":return"unsplash";case"giphy":return"giphy";case"feature-attachment":case"uri":return"link";case"item-resource":return"upload";default:return}},l=(e,t)=>"error"!==e&&(t!==r.Gi.Image||"photo"===e)&&(t!==r.Gi.Video||"video"===e)&&(t!==r.Gi.ImageOrVideo||"photo"===e||"video"===e),d=(e,t)=>{let i=new Set,a=e.concat(t),r=[];for(let e=0;e<a.length;e++){let t=a[e];i.has(t.id)||(r.push(t),i.add(t.id))}return r};function u(e,t,i){let s=[];switch(e){case r.Gi.Image:s=[...a.h3,...t.SUPPORTED_CONVERTIBLE_IMAGE_MIME_TYPES];break;case r.Gi.Audio:s=[...a.I1,...t.SUPPORTED_CONVERTIBLE_AUDIO_MIME_TYPES];break;case r.Gi.Video:s=[...a.E_,...t.SUPPORTED_CONVERTIBLE_VIDEO_MIME_TYPES];break;case r.Gi.File:s=[...a.KV]}return s.reduce((e,t)=>i&&i.includes(t)?[...e]:[...e,t],[])}let c=(e,t,i)=>e===r.Gi.Image?i.SUPPORTED_CONVERTIBLE_IMAGE_MIME_TYPES.includes(t):e===r.Gi.GeoData||(e===r.Gi.Audio?i.SUPPORTED_CONVERTIBLE_AUDIO_MIME_TYPES.includes(t):i.SUPPORTED_CONVERTIBLE_VIDEO_MIME_TYPES.includes(t))},863982:function(e,t,i){i.d(t,{$O:function(){return m},$y:function(){return s},B_:function(){return k},CZ:function(){return w},E5:function(){return L},E_:function(){return b},G5:function(){return a},Hj:function(){return G},I1:function(){return S},Iv:function(){return P},J8:function(){return N},KV:function(){return D},MH:function(){return u},Ry:function(){return B},Sb:function(){return y},TD:function(){return U},Tb:function(){return v},W8:function(){return o},WB:function(){return _},X9:function(){return R},Xg:function(){return h},dr:function(){return n},e2:function(){return x},fG:function(){return d},h3:function(){return g},hH:function(){return p},jD:function(){return F},jH:function(){return c},lM:function(){return Z},mD:function(){return T},nt:function(){return E},qf:function(){return r},qk:function(){return f},rO:function(){return C},vr:function(){return M},wm:function(){return I},xP:function(){return A},zO:function(){return l}});let a="text-editor",r="placeholder",s=`.${r}`,o='span[data-slate-placeholder="true"]',n=`.${a}`,l="caption-editor-container",d=`.${l}`,u="story-container",c=`.${u}`,h="briefing-slideshow",m="briefing-outline",p="smesrimktanalytics",y="ArcGIS StoryMaps Enterprise Edition",f="https://example.com",g=["image/png","image/jpeg","image/gif","image/bmp","image/svg+xml"],b=["video/mp4"],S=["audio/mp3","audio/mpeg","audio/wav","audio/x-wav"],D=["application/pdf","text/vtt"],I=["text/vtt"],w=["application/gpx+xml","gpx"],_=1e7,v=5e7,P=25e6,E="smitem1",T="56rem",A=60,R=140,C=125,Z=500,M=+(16/9).toFixed(4),N="Story data overwrite rejected",L=60,x=1080,O="41.7rem",k=O,U=O,B=5e3,F="https://apps.apple.com/us/app/storymaps-app/id1553131276",G="https://play.google.com/store/apps/details?id=com.esri.storymaps"},422377:function(e,t,i){i.d(t,{b:function(){return r},v:function(){return a}});let a={access:i(641391).eJ.PRIVATE,groups:[],isUnlisted:!1},r={title:"common.arcgis.visibility.selector.accessLevel.heading",description:"common.arcgis.sharing.selector.accessLevel.description"}},453846:function(e,t,i){var a,r,s,o,n,l,d,u;i.d(t,{Gi:function(){return s},Nf:function(){return a},i1:function(){return r},vN:function(){return o}}),(n=a||(a={})).published="smversionpublished",n.draft="smversiondraft",(l=r||(r={})).publishedDate="smpublisheddate",l.firstPublishedDate="smfirstpublisheddate",(d=s||(s={})).Code="code",d.Image="image",d.Video="video",d.ImageOrVideo="image-or-video",d.Audio="audio",d.Embed="embed",d.Map="map",d.WebMap="webmap",d.ExpressMap="expressmap",d.MobilePackage="mobile-package",d.ThematicMap="thematic-map",d.ReadyToUseMap="ready-to-use-map",d.ActivityMap="activity-map",d.Tour="tour",d.Gallery="gallery",d.Table="table",d.Sidecar="sidecar",d.Swipe="swipe",d.Timeline="timeline",d.Custom="custom",d.Globe="globe",d.Terrain="terrain",d.ImageEditor="imageEditor",d.Viewer3D="viewer3D",d.Charting="charting",d.ExpressMapping="expressMapping",d.BinVisualization="binVisualization",d.Template="template",d.File="file-item",d.GeoData="geo-data",(u=o||(o={}))[u.Full=1920]="Full",u[u.Wide=1200]="Wide",u[u.Standard=820]="Standard"},718895:function(e,t,i){i.d(t,{Z:function(){return r}});var a=i(768995);class r extends Error{constructor(e){super(),this.name="StoryBuilderError";let{type:t,itemType:i}=e;this.type=this.message=t,this.itemType=i;let{statusCode:r}=(0,a.P)(this.type);this.statusCode=r}}},768995:function(e,t,i){i.d(t,{P:function(){return l},v:function(){return d}});var a=i(552322),r=i(342670),s=i(428915),o=i(103010),n=i(788028);let l=e=>{let t;let i="unknown";switch(e){case"story-privileges-create":case"story-privileges-edit":case"story-privileges-preview":case"theme-public-account":case"briefing-public-account":case"template-public-account":case"story-inaccessible":case"unsupported-account":case"sign-in":case"blocked-org":i=e,t=403;break;case"item-not-supported-on-route":case"story-not-found":i=e,t=404;break;case"story-load":case"org-settings-load":i=e,t=500;break;default:i="unknown",t=500}return{errorType:i,statusCode:t}},d=(e,t)=>({"unsupported-account":{title:(0,a.jsx)(r.Z,{id:"page.error.unsupportedTitle"}),description:(0,a.jsx)(r.Z,{id:`page.error.${t}.unknownDescription`})},"sign-in":{description:(0,a.jsx)(r.Z,{id:"page.error.signInDescription"})},"story-inaccessible":{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.inaccessibleDescription`})},"story-not-found":{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.inaccessibleDescription`})},"story-privileges-create":{description:(0,a.jsx)(r.Z,{id:"page.error.items.privilegesCreateDescription"})},"story-privileges-edit":{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.privilegesEditDescription`})},"story-privileges-preview":{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.privilegesPreviewDescription`})},"item-not-supported-on-route":{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.inaccessibleDescription`})},"story-load":{description:(0,a.jsx)(r.Z,{id:"page.error.item.loadDescription"})},"org-settings-load":{description:(0,a.jsx)(r.Z,{id:"page.error.orgSettings.loadDescription"})},"theme-public-account":{title:(0,a.jsx)(r.Z,{id:"page.error.unknownTitle"}),description:(0,a.jsx)(r.Z,{id:"publicAccount.disabled.link",values:{"product-doc":e=>(0,a.jsx)("a",{href:"https://storymaps.arcgis.com/redirect/pricing",children:e})}})},"template-public-account":{title:(0,a.jsx)(r.Z,{id:"page.error.unknownTitle"}),description:(0,a.jsx)(r.Z,{id:"publicAccount.disabled.link",values:{"product-doc":e=>(0,a.jsx)("a",{href:"https://storymaps.arcgis.com/redirect/pricing",children:e})}})},"briefing-public-account":{title:(0,a.jsx)(r.Z,{id:"page.error.unknownTitle"}),description:(0,a.jsx)(r.Z,{id:"publicAccount.disabled.link",values:{"product-doc":e=>(0,a.jsx)("a",{href:"https://storymaps.arcgis.com/redirect/pricing",children:e})}})},"blocked-org":{icon:(0,a.jsx)(o.Z,{path:s.Z,size:32,sizeMultiplier:3,fill:n.default.color.emeraldGreen}),description:(0,a.jsx)(r.Z,{id:"page.error.noAccess"}),link:{href:`https://${e}`,isExternal:!0,text:(0,a.jsx)(r.Z,{id:"page.error.arcgisHome"})}},"distributed-collab-no-draft":{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.unknownDescription`})},unknown:{description:(0,a.jsx)(r.Z,{id:`page.error.${t}.unknownDescription`})}})},186261:function(e,t,i){i.d(t,{T:function(){return r},z:function(){return a}});class a extends Error{constructor(e,t){super("Draft data is missing"),this.itemId=e,t&&(this.recoveryDraftData=t)}getRecoveryDataForDownload(){if(this.recoveryDraftData)return`data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(this.recoveryDraftData))}`}}let r=e=>e instanceof a&&!!e.recoveryDraftData},457945:function(e,t,i){i.d(t,{$U:function(){return f},Fn:function(){return y},PR:function(){return b},RZ:function(){return m},U_:function(){return p},Zr:function(){return S},mI:function(){return D},rV:function(){return h},zb:function(){return g}});var a=i(653646),r=i(798396),s=i(447878),o=i(293786),n=i(820666),l=i(863982),d=i(453846),u=i(257660),c=i(612423);let h=e=>{let{itemType:t,config:i,isPublicUser:a,isTemplate:u,orgId:h}=e,m=[...i.NEW_ITEM_TYPEKEYWORDS,r.PC.draft,`${d.Nf.draft}:${i.APP_VERSION}`,s.Zv];t===o.o.Collection&&m.push(s.fp),t===o.o.Briefing&&(m.push(s.Am),m.push("alphabriefing")),t===o.o.Frame&&(m.push(s.d0),m.push("alphaframe")),a&&m.push(l.nt),u&&m.push(s.CB),h&&i.ESRI_MARKETING_ANALYTICS&&i.ESRI_MARKETING_ANALYTICS.orgIds.includes(h)&&m.push(l.hH);let p=t===o.o.Theme?s.j3:s.Cs;return{title:(0,c.bH)({type:t}),tags:[""],typeKeywords:m,type:p,properties:(0,n.M)({thumbnail:["default"]},"replace")}},m=(e,t)=>e&&t&&"undefined"!==e&&"undefined"!==t?`${e} ${t}`:"",p=e=>{let t=(0,a.vx)(),i=(0,a.vx)(),r=(0,a.vx)(),s=(0,a.S3)(),o={root:t,nodes:{[t]:{type:"story",data:{storyTheme:s},config:{coverDate:"first-published",...e.shouldIncludeAuthorCard?{isShowingAuthorCard:!0}:{}},children:[i,r]},[i]:{type:"storycover",data:{type:e.coverType,title:e.title??"",summary:"",byline:m(e.firstName,e.lastName)}},[r]:{type:"navigation",data:{links:[]},config:{isHidden:!0}}},resources:{[s]:{type:"story-theme",data:{themeId:e.baseThemeId,themeBaseVariableOverrides:{},...e.theme&&{themeItemId:e.theme}}}}},n=o.nodes[t].children;if(!n)throw Error("new story created with no children block");if("string"==typeof e.webmap){let t=`r-${e.webmap}`,i=(0,a.vx)();o.resources[t]={type:"webmap",data:{itemId:e.webmap,itemType:"Web Map",type:"default"}},n.push(i),o.nodes[i]={type:"webmap",data:{map:t}}}if("string"==typeof e.webscene){let t=`r-${e.webscene}`,i=(0,a.vx)();o.resources[t]={type:"webmap",data:{itemId:e.webscene,itemType:"Web Scene",type:"default"}},n.push(i),o.nodes[i]={type:"webmap",data:{map:t}}}!e.isTemplate&&(0,c.so)(e.template)&&I(e.template,r,o);let l=(0,a.vx)();return n.push(l),o.nodes[l]={type:"credits"},o},y=e=>({root:"n-11EM0R",nodes:{"n-11EM0R":{type:"frame",data:{storyTheme:"r-eG121q",storyLogoResource:"r-5fkyWk"},config:{shouldShowLogoOnCover:!0},children:["n-7jkzyu"]},"n-7jkzyu":{type:"frame-custom",data:{cover:"n-hvD8mw",panelStyle:"default"},children:["n-fROiA7","n-fROiA8","n-80UbFv","n-80Ub2343v"]},"n-hvD8mw":{type:"storycover",data:{type:"standard",title:"This is custom frame - dummy JSON",summary:"Adding long description here. Adding long description here. Adding long description here. Adding long description here. Adding long description here. Adding long description here. Adding long description here. ",style:"linear-gradient"},children:["n-70Uesq"]},"n-fROiA7":{type:"frame-slide",data:{backgroundColor:"backgroundColor",foreground:"n-NDSqT3",poi:{text:"ESRI Headquarter - Redlands",lat:33.67893,long:-118.00157}},config:{showPoi:!0}},"n-NDSqT3":{type:"frame-narrative-panel",data:{position:"center-middle",size:"large",panelStyle:"themed"},config:{isHidden:!1},children:["n-DNSqT3"]},"n-DNSqT3":{type:"text",data:{text:"This is text slide in a custom frame. This is type paragraph and size is large.",textSize:"large",textAlignment:"start",type:"paragraph"}},"n-fROiA8":{type:"frame-slide",data:{backgroundColor:"backgroundColor",foreground:"n-NDSqT4",poi:{text:"ESRI Headquarter - Redlands",lat:33.67893,long:-118.00157}},config:{showPoi:!0}},"n-NDSqT4":{type:"frame-narrative-panel",data:{position:"center-middle",size:"large",panelStyle:"themed"},config:{isHidden:!1},children:["n-DNSqT4"]},"n-DNSqT4":{type:"text",data:{text:"This is text slide in a custom frame. This is type quote.",textSize:"medium",textAlignment:"start",type:"quote",attribution:"This is quote attribution on text slide in custom frame"}},"n-80UbFv":{type:"frame-slide",data:{background:"n-gKjCMy",foreground:"n-B4v9mv",poi:{text:"POI on Image slide",lat:34.05717,long:-117.19415}},config:{showPoi:!0}},"n-gKjCMy":{type:"image",data:{image:"r-t1CtPm"},config:{placement:{fill:{x:.5,y:.5},fit:{backgroundType:"blurredMedia",color:"backgroundColor"},type:"fill"}}},"n-70Uesq":{type:"image",data:{image:"r-Plyt9p"},config:{placement:{fill:{x:.5,y:.5},fit:{backgroundType:"blurredMedia",color:"backgroundColor"},type:"fit"}}},"n-B4v9mv":{type:"frame-narrative-panel",data:{position:"center-bottom",size:"medium",panelStyle:"themed"},config:{isHidden:!1},children:["n-4BSqT3"]},"n-4BSqT3":{type:"text",data:{text:"This is image caption",textSize:"medium",textAlignment:"start",type:"paragraph"}},"n-80Ub2343v":{type:"frame-slide",data:{background:"n-MqR4LM",foreground:"n-B4v9mvv"},config:{showPoi:!0}},"n-MqR4LM":{type:"expressmap",data:{map:"r-BpYsPs",alt:"",caption:"expressmap.caption"},config:{size:"standard"}},"n-B4v9mvv":{type:"frame-narrative-panel",data:{position:"center-bottom",size:"medium",panelStyle:"themed"},config:{isHidden:!1},children:["n-4BSqT3s"]},"n-4BSqT3s":{type:"text",data:{text:"This is an expressmap caption",textSize:"medium",textAlignment:"start",type:"paragraph"}}},resources:{"r-eG121q":{data:{themeId:"savanna",themeBaseVariableOverrides:{}},type:"story-theme"},"r-t1CtPm":{data:{height:1e3,width:562,provider:"item-resource",resourceId:"8b8af63d96b2105faf4715f1f007cc5c.jpeg"},type:"image"},"r-5fkyWk":{data:{height:1e3,width:562,provider:"item-resource",resourceId:"bd29bf26a756eb4b0c09f46e0cfb5334.jpeg"},type:"image"},"r-Plyt9p":{data:{height:4e3,width:2250,provider:"item-resource",resourceId:"28cc343166b57c3eadb9d1142fce1c2.jpeg"},type:"image"},"r-BpYsPs":{type:"expressmap",data:{src:`${e}/static/storymaps-builder/expressmaps/theme_preview_sample_expressmap_with_points.json`,provider:"uri"}}}}),f=e=>{let t=(0,a.vx)(),i=(0,a.vx)(),r=(0,a.vx)(),s=(0,a.vx)(),o=(0,a.S3)(),n={type:"story-theme",data:{themeId:e.baseThemeId,themeBaseVariableOverrides:{},...e.theme&&{themeItemId:e.theme}}};return{root:t,nodes:{[t]:{type:"collection",data:{storyTheme:o},children:[i]},[i]:{type:"collection-ui",data:{items:[]},children:[r,s]},[r]:{type:"collection-cover",data:{title:e.title??"",summary:"",byline:m(e.firstName,e.lastName),type:"tiles"}},[s]:{type:"collection-nav",data:{type:"compact"}}},resources:{[o]:n}}},g=e=>{let t=(0,a.vx)(),i=(0,a.S3)(),r=(0,a.vx)(),s=(0,a.vx)(),o=(0,a.vx)(),n={type:"story-theme",data:{themeId:e.baseThemeId,themeBaseVariableOverrides:{},...e.theme&&{themeItemId:e.theme}}},l={root:t,nodes:{[t]:{type:"briefing",data:{storyTheme:i},children:[r]},[r]:{type:"briefing-ui",children:[s]},[s]:{type:"briefing-slide",data:{layout:"cover"},children:[o]},[o]:{type:"storycover",data:{type:"sidebyside",title:"",summary:"",byline:m(e.firstName,e.lastName),titlePanelHorizontalPosition:"start"}}},resources:{[i]:n}};if(!l.nodes[t].children)throw Error("new briefing created with no children block");return l},b=e=>!e||/^(StoryMap|StoryMapCollection|Theme|StoryMapBriefing) \d{10,15}$/.test(e),S=e=>`${e}${u.xx}`,D=async e=>{let t=`${location.origin}${S(e)}`,i=await fetch(t);return await i.blob()},I=(e,t,i)=>{if(!i.nodes[i.root].children)throw Error("Could not insert template nodes, root node does not have children.");let r=(0,a.vx)(),s=i.nodes[i.root].children.indexOf(t)+1;if(i.nodes[i.root].children.splice(s,0,r),e.startsWith("sidecar")){let t=(0,a.vx)();i.nodes[r]={type:"immersive",data:{type:"sidecar",subtype:"sidecar-floating"===e?"floating-panel":"docked-panel",narrativePanelPosition:"start",narrativePanelSize:"small"},children:[t]};let s=(0,a.vx)();i.nodes[t]={type:"immersive-slide",data:{transition:"fade"},children:[s]},i.nodes[s]={type:"immersive-narrative-panel",data:{panelStyle:"themed",position:"start",size:"small"}}}else if(e.startsWith("guided-tour")||e.startsWith("explorer")){let t=e.startsWith("guided-tour");i.nodes[r]={type:"tour",data:{type:t?"guided-tour":"explorer",subtype:t?"guided-tour-media"===e?"media-focused":"map-focused":"explorer-grid"===e?"grid":"list"}}}}},140995:function(e,t,i){i.d(t,{oM:function(){return m},eG:function(){return eN},ZP:function(){return eL}});var a,r,s,o,n,l,d,u,c,h,m,p,y=i(69378),f=i(395486),g=i(348206),b=i(368667),S=i(379293),D=i(278921),I=i(844407),w=i(650221),_=i(81052),v=i(974712),P=i(136630),E=i(293786);(a=d||(d={}))[a.DRAFT_SAVE=0]="DRAFT_SAVE",a[a.PUBLISHING=1]="PUBLISHING",a[a.UNPUBLISHING=2]="UNPUBLISHING",a[a.DISCARDING_UNPUBLISHED_CHANGES=3]="DISCARDING_UNPUBLISHED_CHANGES",(r=u||(u={})).publishedDate="smpublisheddate",r.firstPublishedDate="smfirstpublisheddate",(s=c||(c={})).published="smversionpublished",s.draft="smversiondraft",(o=h||(h={})).DRAFT="draft",o.PUBLISHED="published";var T=i(447878);let A=async e=>{let{authManager:t,itemId:i,mode:a,relationships:r}=e,s={destinationItemId:i,authentication:t},o=[],n=(await (0,g.oO)({authentication:t,id:i,relationshipType:T.t4})).relatedItems.map(e=>e.id),l=r.reduce((e,t)=>t.type!==T.t4||n.includes(t.itemId)?e:e.concat(t),[]),u=[];n.forEach(e=>{r.find(t=>t.type===T.t4&&t.itemId===e)||u.push({itemId:e,type:T.t4})},[]),l.forEach(e=>{o.push((0,g.bV)({...s,originItemId:e.itemId,relationshipType:e.type}))}),u.forEach(e=>{o.push((0,g.Fr)({...s,originItemId:e.itemId,relationshipType:e.type}))}),a===d.DRAFT_SAVE||a===d.DISCARDING_UNPUBLISHED_CHANGES?await Promise.allSettled(o):await Promise.all(o)};class R extends Error{constructor(e,t){super(t),this.resourceProperties=e}}var C=i(652202);let Z=async e=>{let{authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:r,itemId:s,itemResourcesEditInfo:o}=e,n=await (0,g.rV)(s,{authentication:t}),l=(0,b.Sg)({portalHost:i.PORTAL_HOST,itemDetails:n,fallbackUrl:a,shouldIgnoreDPR:!0,returnOriginalAspectRatio:!0,size:800}),d=await (0,S.pz)(l),{title:u,url:c="",byline:h}=n,m={version:"1.0",type:"rich",title:u,url:c,author_name:h,provider_name:`${i.PRODUCT_NAME}`,provider_url:new URL(c).origin,width:800,height:600,thumbnail_url:`${l}`,thumbnail_height:`${d.height}`,thumbnail_width:`${d.width}`,html:`<iframe src="${c}" width="800" height="600" scrolling="yes" frameborder="0" allowfullscreen></iframe>`,cache_age:86400},p=`<?xml version="1.0" encoding="utf-8" standalone="yes"?>
    <oembed>
      <version>1.0</version>
      <type>rich</type>
      <title>${u}</title>
      <url>${c}</url>
      <author_name>${h}</author_name>
      <provider_name>${i.PRODUCT_NAME}</provider_name>
      <provider_url>${new URL(c).origin}</provider_url>
      <width>800</width>
      <height>600</height>
      <thumbnail_url>${l}</thumbnail_url>
      <thumbnail_height>${d.height}</thumbnail_height>
      <thumbnail_width>${d.width}</thumbnail_width>
      <html><iframe src="${c}" width="800" height="600" scrolling="yes" frameborder="0" allowfullscreen="true"></iframe></html>
      <cache_age>86400</cache_age>
    </oembed>
    `;return await Promise.all([M({authManager:t,config:i,isDataLossAllowed:r,isPublished:!0,itemDetails:n,itemResourcesEditInfo:o,resourceName:"oembed.json",resource:(0,D.ds)(m)}),M({authManager:t,config:i,isDataLossAllowed:r,isPublished:!0,itemDetails:n,itemResourcesEditInfo:o,resourceName:"oembed.xml",resource:new Blob([p],{type:"text/xml"})})]),{xml:p,json:m}},M=async e=>{let t,i;let a=e.authManager;if(!a)throw Error("no user session");let{id:r,owner:s}=e.itemDetails,{PORTAL_HOST:o}=e.config,n=(0,I.$9)(e.resourceName)?w._H:e.resourceName,l=!e.resource&&!e.options?.params?.text&&!e.resourceProperties&&!e.options?.params?.properties;e.isRemove||n!==w._H&&(e.isAdd||l)||(t=await (0,w.$J)({resourceName:n,itemId:r,itemOwner:s,portalHost:o,authManager:a}),await L({authManager:a,config:e.config,itemDetails:e.itemDetails,isDataLossAllowed:e.isDataLossAllowed,resourceName:n,currentResourceProperties:t,itemResourcesEditInfo:e.itemResourcesEditInfo}));let d=o=>(i={editor:a.username,modified:Date.now(),id:(0,f.x0)()},{authentication:a,id:r,name:e.resourceName,resource:e.resource,owner:s,private:!0!==e.isPublished,...e.options,params:{...e.options?.params,...o||!l?{properties:(0,w.x7)({newProps:{...e.options?.params?.properties,...e.resourceProperties,editInfo:i},currentProps:t})}:{}}});if(!0===e.isAdd){let t=await (0,g.zJ)(d(!0));return await N({authManager:a,resourceName:n,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t}if(!1===e.isAdd){let t=await (0,g.zy)(d(!1));return await N({authManager:a,resourceName:n,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t}if(!0===e.isRemove){let t=d(!1),r=await (0,g.ug)({authentication:t.authentication,id:t.id,resource:t.name,owner:t.owner});return n!==w._H&&await N({authManager:a,resourceName:n,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo,removeTrackingInfo:!0}),r}try{let t=await (0,g.zy)(d(!1));if(t.success)return await N({authManager:a,resourceName:n,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t;throw t}catch(r){let t=await (0,g.zJ)(d(!0));return await N({authManager:a,resourceName:n,editInfo:i,config:e.config,itemDetails:e.itemDetails,itemResourcesEditInfo:e.itemResourcesEditInfo}),t}},N=async e=>{let{authManager:t,config:i,editInfo:a,itemDetails:r,removeTrackingInfo:s,resourceName:o,itemResourcesEditInfo:n}=e;if(s){delete n[o];return}let l=(0,I.$9)(o)?w._H:o;if(a)n[l]=a;else{let e=await (0,w.$J)({resourceName:l,itemId:r.id,authManager:t,portalHost:i.PORTAL_HOST,itemOwner:r.owner});n[l]=e?.editInfo}},L=async e=>{let{authManager:t,config:i,currentResourceProperties:a,isDataLossAllowed:r,itemDetails:s,itemResourcesEditInfo:o,resourceName:n}=e;if(!r&&(n=n?(0,I.$9)(n)?w._H:n:w._H,a=a||await (0,w.$J)({resourceName:n,itemId:s.id,itemOwner:s.owner,portalHost:i.PORTAL_HOST,authManager:t}),a?.editInfo?.id&&o?.[n]?.id&&o?.[n]?.id!==a?.editInfo?.id))throw new R(a,"Data resource will be overwritten")},x=async e=>{let{authManager:t,config:i,draftResourceId:a,mode:r,itemDetails:s,itemData:o,itemDraftData:n,isDataLossAllowed:l,isDuplicateCleanup:u,itemResourcesEditInfo:c,itemResourceIdsToKeep:m,type:p}=e,y=r!==d.DISCARDING_UNPUBLISHED_CHANGES?n:void 0,f=r===d.UNPUBLISHING?void 0:o,g=(0,C.Wr)(y,f,p),S=await (0,b.vb)({authManager:t,username:s.owner,itemId:s.id,portal:(0,_.Zl)(i.PORTAL_HOST,t)}),D=await O({authManager:t,config:i,itemId:s.id,resources:g.publishedItemResources,version:h.PUBLISHED,mode:r}),w=await O({authManager:t,config:i,itemId:s.id,resources:g.draftItemResources,version:h.DRAFT,mode:r}),T=u?{maxRetries:60,delay:5e3}:d.DRAFT_SAVE?{maxRetries:0}:{},R=S.map(e=>{let o=e.resource;if(o===a||r===d.DRAFT_SAVE&&(["oembed.json","oembed.xml",v.f].includes(o)||m?.has(b.gJ(o))||!(0,I.$9)(o)&&Date.now()-864e5<e.created));else if(D.indexOf(o)>=0){if("inherit"!==e.access)return(0,P.Up)(M,{...T,promiseArguments:[{authManager:t,config:i,isAdd:!1,isPublished:!0,itemDetails:s,itemResourcesEditInfo:c,resourceName:o}]})}else if(!(w.indexOf(o)>=0))return(0,P.Up)(M,{...T,promiseArguments:[{authManager:t,config:i,isRemove:!0,itemDetails:s,itemResourcesEditInfo:c,resourceName:o}]});else if("private"!==e.access)return(0,P.Up)(M,{...T,promiseArguments:[{authManager:t,config:i,isAdd:!1,isPublished:!1,itemDetails:s,itemResourcesEditInfo:c,resourceName:o}]})}),Z=await Promise.all(R);if(r===d.PUBLISHING){let e=g.itemResourcesToPublish.map(e=>{if((0,C.kr)(e.type))return U({authManager:t,config:i,itemDetails:s,filename:e.id,source:h.DRAFT,destination:h.PUBLISHED,isDataLossAllowed:l,itemResourcesEditInfo:c})}),a=await Promise.all([...e]);Z=Z.concat(a)}else if(r===d.DISCARDING_UNPUBLISHED_CHANGES){let e=g.publishedItemResources.map(e=>{if((0,C.kr)(e.type))return U({authManager:t,config:i,itemDetails:s,filename:e.id,source:h.PUBLISHED,destination:h.DRAFT,isDataLossAllowed:l,itemResourcesEditInfo:c})}),a=await Promise.all([...e]);Z=Z.concat(a)}return p!==E.o.Theme&&await A({authManager:t,itemId:s.id,relationships:g.relatedItems,mode:r}),Z},O=async e=>{let{resources:t,version:i,mode:a,itemId:r,authManager:s,config:o}=e,n=[],l=t.map(e=>"expressmap"===e.type?(i===h.PUBLISHED&&a===d.PUBLISHING?n.push(k({authManager:s,config:o,itemId:r,expressMapId:e.id,version:h.DRAFT})):i===h.DRAFT&&a===d.DISCARDING_UNPUBLISHED_CHANGES?n.push(k({authManager:s,config:o,itemId:r,expressMapId:e.id,version:h.PUBLISHED})):n.push(k({authManager:s,config:o,itemId:r,expressMapId:e.id,version:i})),(0,b.rj)(e.id,i)):(0,C.kr)(e.type)?(0,b.rj)(e.id,i):e.id,[]);return(await Promise.all(n)).reduce((e,t)=>e.concat(t),l)},k=async e=>{let{authManager:t,config:i,expressMapId:a,itemId:r,version:s}=e,o=B({authManager:t,config:i,itemId:r,filename:a,version:s}),n=await (0,y.WY)(o,{authentication:t});return Object.keys(n.popups).reduce((e,t)=>{let i=n.popups[t];return i.image&&"string"==typeof i.image?e.concat(i.image):e},[])},U=async e=>{let{authManager:t,config:i,destination:a,filename:r,isDataLossAllowed:s,itemDetails:o,itemResourcesEditInfo:n,source:l}=e,d=B({authManager:t,config:i,itemId:o.id,filename:r,version:l}),u=await (0,y.WY)(d,{authentication:t});return M({authManager:t,config:i,itemDetails:o,isDataLossAllowed:s,isPublished:a===h.PUBLISHED,resourceName:(0,b.rj)(r,a),resource:(0,D.ds)(u),itemResourcesEditInfo:n})},B=e=>{let{authManager:t,config:i,filename:a,itemId:r,version:s}=e;return`${(0,_.Zl)(i.PORTAL_HOST,t)}/content/items/${r}/resources/${(0,b.rj)(a,s)}`};var F=i(641391),G=i(180997),H=i(902183),$=i(999354);let j=Object.freeze({[E.o.Story]:$.Z.Category.Story,[E.o.Collection]:$.Z.Category.Collection,[E.o.Theme]:$.Z.Category.Theme,[E.o.Briefing]:$.Z.Category.Briefing,[E.o.Frame]:$.Z.Category.Frame}),K={[E.o.Story]:$.Z.Category.StoryTemplate},V=async e=>{let{authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:r,itemResourcesEditInfo:s,itemDetails:o,sharingLevel:n,type:l}=e,d=n.isUnlisted&&n.access===F.eJ.PUBLIC,u=await (0,b.mY)({itemDetails:o,authManager:t}),c=await t.getUser(),h=[].concat(c.groups||[]).reduce((e,t)=>(e[t.id]=t,e),{}),m=c.favGroupId,p=(0,b.A7)(o,t),y=u.filter(e=>e!==m&&!n.groups?.includes(e)&&(0,G.Q)({group:h[e],hasItemOwnerPermission:p,allowSharingToUpdateGroups:!0})),f=(n.groups??[]).filter(e=>e!==m&&!u?.includes(e)&&(0,G.Q)({group:h[e],hasItemOwnerPermission:p,allowSharingToUpdateGroups:!0})),S=!1,D=o.typeKeywords?.includes(T.L7);d&&!D?(o.typeKeywords?.push(T.L7),S=!0):!d&&D&&(o.typeKeywords=o.typeKeywords?.filter(e=>e!==T.L7),S=!0);let I=(0,b.fW)(o),w=(0,H.qg)(o);!I&&(w||n.isViewerDuplicable)?(o.isViewerCopiable=!0,S=!0):!n.isViewerDuplicable&&I&&(o.isViewerCopiable=!1,S=!0);let _=o.typeKeywords?.includes(T.LB);(n.isIndexable&&n.access===F.eJ.PUBLIC||n.access!==F.eJ.PUBLIC)&&_?(o.typeKeywords=o.typeKeywords?.filter(e=>e!==T.LB),S=!0):n.access!==F.eJ.PUBLIC||n.isIndexable||_||(o.typeKeywords?.push(T.LB),S=!0),S&&(await (0,g.$G)({authentication:t,item:o}),S=!1);let v=p?[(0,g.zT)({id:o.id,access:n.access===F.eJ.SHARED?F.eJ.PRIVATE:n.access,authentication:t,owner:o.owner})]:[],P=f.map(e=>(0,g.Ju)({id:o.id,groupId:e,confirmItemControl:!0,authentication:t,owner:o.owner})),A=y.map(e=>(0,g.lF)({id:o.id,groupId:e,authentication:t,owner:o.owner}));n.access===F.eJ.PUBLIC&&l!==E.o.Theme&&await Z({authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:r,itemId:o.id,itemResourcesEditInfo:s});let R=w&&l===E.o.Story?K[l]:j[l];return $.Z.trackEvent(R,$.Z.Action.Story_ShareStory,n.isUnlisted?"unlisted":n.access),await Promise.all([...v,...P,...A])};var W=i(798396);let z=e=>{let{mode:t,itemDetails:i,itemDraftData:a}=e;if(t!==d.PUBLISHING&&t!==d.UNPUBLISHING&&(0,H.Ot)(i)!==W.PC.draft)return i;if("object"==typeof a.nodes){let e=(()=>{for(let e of Object.values(a.nodes))if("tour"===e.type&&e.data?.type==="guided-tour")return!0;return!1})(),t=(i.typeKeywords??[]).filter(e=>e!==T.Vk);e&&t.push(T.Vk),i.typeKeywords=t}return i},J=async e=>{let{appVersion:t,authManager:i,config:a,isDataLossAllowed:r,isDuplicateCleanup:s,itemData:o,itemDetails:n,itemDraftData:l,itemResourcesEditInfo:u,itemResourceIdsToKeep:h,mode:m,storeBackup:p,type:f}=e,b=`draft_${Date.now()}.json`,S=n.typeKeywords?.filter(e=>!e.match(c.draft)&&e!==T.Zv)??[];S.push(`${c.draft}:${t}`),n.typeKeywords=S,z({mode:m,itemDetails:n,itemDraftData:l});try{p?.()}catch{}n.typeKeywords=(0,H.TQ)({typeKeywords:n.typeKeywords,typeKeywordId:T.ss}),n.typeKeywords=(0,H.jT)({typeKeywords:n.typeKeywords,typeKeywordId:T.W2,data:b});let I=await M({authManager:i,itemDetails:n,config:a,isPublished:!1,isAdd:!0,isDataLossAllowed:r,itemResourcesEditInfo:u,resourceName:b,resource:(0,D.ds)(l)}),w=n.thumbnail instanceof Blob;if(await (0,y.WY)(`${(0,_.Zl)(a.PORTAL_HOST,i)}/content/users/${n.owner}/items/${n.id}/update
  `,{authentication:i,params:{...n,...w?{thumbnail:n.thumbnail}:{},text:m===d.PUBLISHING||m===d.UNPUBLISHING?o:void 0}}),w){let{thumbnail:e}=await (0,g.rV)(n.id,{authentication:i});n.thumbnail=e}let v=await x({authManager:i,config:a,draftResourceId:b,isDataLossAllowed:r,isDuplicateCleanup:s,itemDetails:n,itemData:o,itemDraftData:l,itemResourcesEditInfo:u,itemResourceIdsToKeep:h,mode:m,type:f});return{draftData:I,itemDetails:n,updateResources:v,itemDraftData:l,itemData:o}},q=(e,t)=>[...t.filter(e=>e!==W.PC.draft&&e!==W.PC.published&&e!==W.PC.unpublishedChanges&&"status:draft"!==e&&"status:published"!==e&&"status:unpublished-changes"!==e),e],Y=e=>{let{itemDetails:t,...i}=e;return(0,H.Ot)(t)===W.PC.published&&(t.typeKeywords=q(W.PC.unpublishedChanges,t.typeKeywords??[])),J({...i,itemDetails:t,mode:d.DRAFT_SAVE})},X=async e=>{let{appVersion:t,authManager:i,config:a,fallbackThumbnailUrl:r,isDataLossAllowed:s,isDuplicateCleanup:o,itemDetails:n,itemDraftData:l,itemResourcesEditInfo:u,sharingLevel:c,storeBackup:h,type:m}=e;n.typeKeywords=Q(n,t);let p=await J({appVersion:t,authManager:i,config:a,isDataLossAllowed:s,isDuplicateCleanup:o,itemDetails:n,itemData:l,itemDraftData:l,itemResourcesEditInfo:u,mode:d.PUBLISHING,storeBackup:h,type:m}),y=await V({authManager:i,config:a,fallbackThumbnailUrl:r,itemDetails:n,isDataLossAllowed:s,itemResourcesEditInfo:u,sharingLevel:c,type:m}),f=await M({authManager:i,config:a,isAdd:!0,isDataLossAllowed:s,isPublished:!0,itemDetails:n,itemResourcesEditInfo:u,resourceName:v.f,resource:(0,D.ds)(l)});return{...p,serverItemData:f,shareItem:y}},Q=(e,t)=>{let i=(0,H._$)({typeKeywords:e.typeKeywords,typeKeywordId:u.firstPublishedDate}),a=(0,H._$)({typeKeywords:e.typeKeywords,typeKeywordId:u.publishedDate}),r=Date.now(),s=e.typeKeywords?.filter(e=>!e.match(u.publishedDate)&&!e.match(c.published)&&!e.match(T.sO))??[];return s.push(`${u.publishedDate}:${r}`),s.push(`${c.published}:${t}`),i||a||s.push(`${u.firstPublishedDate}:${r}`),q(W.PC.published,s)},ee=e=>{let{itemDetails:t,...i}=e;return t.typeKeywords=q(W.PC.published,t.typeKeywords??[]),J({...i,itemDetails:t,itemDraftData:i.itemData,mode:d.DISCARDING_UNPUBLISHED_CHANGES})},et=async e=>{let{authManager:t,config:i,fallbackThumbnailUrl:a,isDataLossAllowed:r,itemDetails:s,itemResourcesEditInfo:o,sharingLevel:n,type:l}=e;s.typeKeywords=ei(s);let u=await J({...e,itemData:{unpublished:!0},mode:d.UNPUBLISHING}),c=await V({authManager:t,config:i,itemDetails:s,isDataLossAllowed:r,fallbackThumbnailUrl:a,sharingLevel:n,itemResourcesEditInfo:o,type:l});return{...u,shareItem:c}},ei=e=>{let t=e.typeKeywords?.filter(e=>!e.match(u.publishedDate)&&!e.match(u.firstPublishedDate)&&!e.match(c.published)&&!e.match("Copy Item")&&!e.match(T.L3))??[];return q(W.PC.draft,t)};var ea=i(820666),er=i(817239),es=i(751368),eo=i(863982),en=i(567523),el=i(422377),ed=i(453846),eu=i(718895),ec=i(332795),eh=i(154742),em=i(326588);let ep=e=>{let t={giphy:0,unsplash:0,coverr:0};for(let i in e){let a=e[i].data.provider;("giphy"===a||"unsplash"===a||"coverr"===a)&&t[a]++}return t},ey=(e,t,i)=>{let a=ep(e);$.Z.trackEvent(t,i,$.Z.Name.UnsplashImage_PublishedStory_Count,a.unsplash),$.Z.trackEvent(t,i,$.Z.Name.GiphyImage_PublishedStory_Count,a.giphy),$.Z.trackEvent(t,i,$.Z.Name.CoverrVideo_PublishedStory_Count,a.coverr)},ef=Object.freeze({resource:"customTheme",order:"themeBasemap",media:"mediaBasemap",locale:"chineseBasemap",name:"basemapPicker",json:"jsonBasemap"}),eg=async(e,t,i,a,r)=>{let s=Object.keys(t);await Promise.all(s.map(async s=>{if("expressmap"===t[s].type){let o=B({authManager:a,config:r,filename:t[s]?.data.itemId,itemId:i,version:"draft"}),n=await (0,y.WY)(o,{authentication:a}),l=ef[n.basemap.type]||"unknownBasemap";$.Z.trackEvent(e,$.Z.Action.ExpressMap_PublishedExpressmapBaseMapType,l,0,"name"===n.basemap.type?t[s]?.data.value:void 0)}}))},eb=async e=>{try{let t=e.isTemplate?$.Z.Category.StoryTemplate:({[E.o.Story]:$.Z.Category.Story,[E.o.Frame]:$.Z.Category.Frame,[E.o.Briefing]:$.Z.Category.Briefing,[E.o.Collection]:$.Z.Category.Collection,[E.o.Theme]:$.Z.Category.Theme})[e.type],i=e.isTemplate?$.Z.Category.StoryTemplateStatistics:({[E.o.Story]:$.Z.Category.StoryStatistics,[E.o.Frame]:$.Z.Category.FrameStatistics,[E.o.Briefing]:$.Z.Category.BriefingStatistics,[E.o.Collection]:$.Z.Category.CollectionStatistics,[E.o.Theme]:$.Z.Category.ThemeStatistics})[e.type],a=e.isTemplate?$.Z.Action.StoryTemplate_PublishTemplate:({[E.o.Story]:$.Z.Action.Story_PublishStory,[E.o.Frame]:$.Z.Action.Frame_PublishFrame,[E.o.Briefing]:$.Z.Action.Briefing_PublishBriefing,[E.o.Collection]:$.Z.Action.Collection_PublishCollection,[E.o.Theme]:$.Z.Action.Theme_PublishTheme})[e.type];if((0,H.W$)({typeKeywords:e.itemDetails.typeKeywords??[],typeKeywordId:T.L3}).forEach(t=>{$.Z.trackEvent($.Z.Category.Story,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_Topic:$.Z.Action.StoryStatistics_Republish_Topic,t)}),$.Z.trackEvent(t,a,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish),Object.keys(e.itemData.resources).forEach(i=>{let a=e.itemData.resources[i];if("story-theme"===a.type){let i=a.data.themeItemId??a.data.themeId;$.Z.trackEvent(t,$.Z.Action.GeneralStatistics_PublishedTheme,i,0,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)}}),ey(e.itemData.resources,t,a),await eg(i,e.itemData.resources,e.itemDetails.id,e.authManager,e.config),e.firstPublish){let i,{licenseType:a}=e;a||(a=""),i="SMX Item"===e.itemDetails.type||"SMX Theme"===e.itemDetails.type?"SMX":a.includes("creator")?$.Z.Name.Story_PublishStory_UserType_Creator:a.includes("GISProfessional")?$.Z.Name.Story_PublishStory_UserType_GISProfessional:a.includes("Storyteller")?$.Z.Name.Story_PublishStory_UserType_StoryTeller:$.Z.Name.Story_PublishStory_UserType_Public,$.Z.trackEvent(t,$.Z.Action.Story_PublishStory_UserType,i)}let r=new Date,s=(t,i)=>{if(!t.dependents?.offline)return;let a="string"==typeof t.dependents.offline?t.dependents.offline:t.dependents.offline[0],r=e.itemData.nodes[a].type;i[t.type]?i[t.type][r]=i[t.type][r]+1||1:i[t.type]={[r]:1}};if(e.firstPublish?$.Z.trackEvent(i,$.Z.Action.StoryStatistics_FirstPublish_DayOfMonth,r.getDate().toString()):$.Z.trackEvent(i,$.Z.Action.StoryStatistics_Republish_DayOfMonth,r.getDate().toString()),$.Z.trackEvent(i,(0,b.fW)(e.itemDetails)?$.Z.Action.ItemStatistics_AllowPublishedDuplicate:$.Z.Action.ItemStatistics_DoNotAllowPublishedDuplicate,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish),$.Z.trackEvent(i,(0,b._$)({itemDetails:e.itemDetails,isTemplate:e.isTemplate})?$.Z.Action.ItemStatistics_OptIntoSEO:$.Z.Action.ItemStatistics_OptOutOfSEO,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish),"story"===e.type){let t={},a=0,r=0,s=0;Object.keys(e.itemData.nodes).forEach(o=>{let n=e.itemData.nodes[o];if("immersive-slide"!==n.type&&"immersive-side-panel"!==n.type){if("immersive"===n.type){let e=n.data.type;"sidecar"===e&&(e="floating-panel"===n.data.subtype?"sidecar-float":"docked-panel"===n.data.subtype?"sidecar-docked":"sidecare-slideshow"),n.type=e}else"gallery"===n.type&&(n.type="square-dynamic"===n.data.galleryLayout?"gallery-square-dynamic":"jigsaw"===n.data.galleryLayout?"gallery-jigsaw":"gallery-filmstrip");if("number"==typeof t[n.type]?t[n.type]=t[n.type]+1:t[n.type]=1,("image"===n.type||"video"===n.type||"audio"===n.type||"embed"===n.type||"expressmap"===n.type||"thematic-map"===n.type||"webmap"===n.type||"swipe"===n.type)&&(r+=1,n.data?.alt?.length>0&&(s+=1),"video"===n.type&&"object"==typeof n.data&&"closedCaption"in n.data&&(a+=1)),n.data&&("slideshow"===n.type||"sidecar-float"===n.type||"sidecar-docked"===n.type)&&(n.data.type,$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_SideCar_FirstPublish_SlidesCount:$.Z.Action.StoryStatistics_SideCar_Republish_SlidesCount,$.Z.Name.Builder_Sidecar,n.children?n.children.length:0)),"table"===n.type&&n.data){let{numRows:t,numColumns:a}=n.data;$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_Table_FirstPublish_NumRows:$.Z.Action.StoryStatistics_Table_Republish_NumRows,$.Z.Name.Builder_Table,t),$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_Table_FirstPublish_NumColumns:$.Z.Action.StoryStatistics_Table_Republish_NumColumns,$.Z.Name.Builder_Table,a)}if("tour"===n.type&&n.data){let t="explorer"===n.data.type;$.Z.trackEvent(i,e.firstPublish?t?$.Z.Action.StoryStatistics_Explorer_FirstPublish_SlidesCount:$.Z.Action.StoryStatistics_GuidedTour_FirstPublish_SlidesCount:t?$.Z.Action.StoryStatistics_Explorer_Republish_SlidesCount:$.Z.Action.StoryStatistics_GuidedTour_Republish_SlidesCount,t?$.Z.Name.Builder_Explorer:$.Z.Name.Builder_GuidedTour,n.data.places?n.data.places.length:0);let a="";switch(n.data.subtype){case"map-focused":a="Map_Focused";break;case"media-focused":a="Media_Focused";break;case"list":a="List";break;case"grid":a="Grid"}$.Z.trackEvent(i,t?$.Z.Action.StoryStatistics_Explorer_Layout:$.Z.Action.StoryStatistics_GuidedTour_Layout,a)}if("credits"===n.type&&n.config&&!n.config.isHidden&&$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_CreditsToggledOn:$.Z.Action.StoryStatistics_Republish_CreditsToggledOn),"story"===n.type){if(n.config?.storyLocale&&$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_StoryLocale:$.Z.Action.StoryStatistics_Republish_StoryLocale,n.config.storyLocale),n.config?.analytics){let t=n.config.analytics.type;$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_AuthorAnalytics:$.Z.Action.StoryStatistics_Republish_AuthorAnalytics,t)}n.config?.isSocialIconsHidden&&$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_HideSocialShare:$.Z.Action.StoryStatistics_Republish_HideSocialShare),$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_CoverDate:$.Z.Action.StoryStatistics_Republish_CoverDate,n.config?.coverDate),a>0&&$.Z.trackEvent(i,$.Z.Action.GeneralStatistics_PublishedWithVideoClosedCaption,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,a)}}});let o=e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_NodeCount:$.Z.Action.StoryStatistics_Republish_NodeCount;Object.keys(t).forEach(e=>{$.Z.trackEvent(i,o,e,t[e])});let n=e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_AltTextUsed:$.Z.Action.StoryStatistics_Republish_AltTextUsed,l=r>0&&s>0,d=Math.round(s/r*100);$.Z.trackEvent(i,n,l.toString(),d)}if(e.type===E.o.Theme){let{resources:t,titleFont:a,bodyFont:r,variables:s}=e.itemData,o={title:{action:e.firstPublish?$.Z.Action.ThemeStatistics_FirstPublish_TitleFont:$.Z.Action.ThemeStatistics_Republish_TitleFont,themeVariablesFontId:s.titleFontId},body:{action:e.firstPublish?$.Z.Action.ThemeStatistics_FirstPublish_BodyFont:$.Z.Action.ThemeStatistics_Republish_BodyFont,themeVariablesFontId:s.bodyFontId}};(a=>{let r={google:0};a.forEach(e=>{let{type:a,data:s}=e,n=o[a];if((0,em.ed)(n.themeVariablesFontId)){$.Z.trackEvent(i,n.action,eh.s[n.themeVariablesFontId].displayName);return}if(!s)return;let l=t?.[s.resource]?.data;l&&(r[l.provider]=(r[l.provider]||0)+1,$.Z.trackEvent(i,n.action,l.displayName))}),r.google&&$.Z.trackEvent(i,e.firstPublish?$.Z.Action.ThemeStatistics_FirstPublish_UsedGoogleFonts:$.Z.Action.ThemeStatistics_Republish_UsedGoogleFonts)})([{type:"title",data:a},{type:"body",data:r}])}if(e.type===E.o.Collection){let t=!1;Object.keys(e.itemData.nodes).forEach(a=>{let r=e.itemData.nodes[a];if("collection-cover"===r.type){t=("object"==typeof r.data&&"mapOptions"in r.data?r.data.mapOptions:{}).isEnabled;let a=r.children?r.children?.reduce((t,i)=>{let a=e.itemData.nodes[i];if("text"===a.type){let e=a.data.text,i=ec.dW(e??"");return{nodeCount:t.nodeCount+1,characterCount:t.characterCount+i.length}}return t},{nodeCount:0,characterCount:0}):{nodeCount:0,characterCount:0};$.Z.trackEvent(i,$.Z.Action.Collection_Description_TextBlocks,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,a?.nodeCount),$.Z.trackEvent(i,$.Z.Action.Collection_Description_CharacterCount,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,a?.characterCount)}if("collection-map"===r.type){let t="object"==typeof r.data&&"geometries"in r.data?Object.keys(r.data.geometries).length:0;$.Z.trackEvent(i,$.Z.Action.Collection_LocationCount,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,t)}}),$.Z.trackEvent(i,$.Z.Action.CollectionPublishedWithMap,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,0,t?"true":"false")}if("briefing"===e.type){let t={},a={},r={},o={},n={},l={},d={},u=0;Object.keys(e.itemData.nodes).forEach(c=>{let h=e.itemData.nodes[c];if(t[h.type]=t[h.type]+1||1,"briefing-slide"===h.type){let t=h.data.sublayout?h.data.layout+":"+h.data.sublayout:h.data.layout,s=h.data.contents;if(a[t]=a[t]+1||1,h.data.title){let t=e.itemData.nodes[h.data.title],a=t?.data?.text.length;$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_PublishedSlideTitleLength,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,a)}s&&Object.keys(s).forEach(i=>{let a=s[i];if(Array.isArray(a))a.forEach(i=>{let a=e.itemData.nodes[i].type;if(l[t]?l[t][a]=l[t][a]+1||1:l[t]={[a]:1},l[t]={contentNodeType:l[t][a]+1||1},"text"===a){let t=e.itemData.nodes[i].data.type;r[t]=r[t]+1||1}});else{let i=e.itemData.nodes[a].type;if(l[t]?l[t][i]=l[t][i]+1||1:l[t]={[i]:1},"text"===i){let t=e.itemData.nodes[a].data.type;r[t]=r[t]+1||1}}})}if("storycover"===h.type&&h.children){let t=h.children[0],a=e.itemData.nodes[t].type;$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_CoverMediaType,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,0,a)}if("image"===h.type||"video"===h.type){let e=h.type,t=h.config&&h.config?.placement?h.config.placement.type:"fill";"image"===e&&(o[t]=o[t]+1||1),"video"===e&&(n[t]=n[t]+1||1,"object"==typeof h.data&&"closedCaption"in h.data&&(u+=1))}("webmap"===h.type||"expressmap"===h.type||"embed"===h.type)&&s(h,d)}),Object.keys(t).forEach(a=>{$.Z.trackEvent(i,e.firstPublish?$.Z.Action.StoryStatistics_FirstPublish_NodeCount:$.Z.Action.StoryStatistics_Republish_NodeCount,a,t[a])}),Object.keys(a).forEach(t=>{$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_PublishedSlideLayoutCount,t,a[t],e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)}),Object.keys(l).forEach(t=>{Object.keys(l[t]).forEach(a=>{$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_PublishedSlideLayoutContentCount,t,l[t][a],a,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)})}),Object.keys(d).forEach(t=>{Object.keys(d[t]).forEach(a=>{$.Z.trackEvent(i,$.Z.Action.StoryStatistics_OfflineMediaUsedBy+t,$.Z.Name.OfflineMedia_Type+a,d[t][a],e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)})}),Object.keys(r).forEach(t=>{$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_PublishedTextTypeCount,t,r[t],e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)}),Object.keys(o).forEach(t=>{$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_PublishedImagePlacementCount,t,o[t],e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)}),Object.keys(n).forEach(t=>{$.Z.trackEvent(i,$.Z.Action.BriefingStatistics_PublishedVideoPlacementCount,t,n[t],e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish)}),u>0&&$.Z.trackEvent(i,$.Z.Action.GeneralStatistics_PublishedWithVideoClosedCaption,e.firstPublish?$.Z.Name.Story_PublishStory_FromDraft:$.Z.Name.Story_PublishStory_Republish,u)}}catch{return}};var eS=i(457945);function eD(e){return"story"===e.type||"collection"===e.type||"briefing"===e.type}function eI(e){return["storycover","collection-cover"].includes(e.type)}var ew=i(526280);let e_=async e=>{let{type:t,itemDetails:i,itemProperties:a,thumbnail:r,baseUrl:s,authManager:o,portalHost:n,shouldPushMetaToAGOItemDetails:l,shouldForceUpdateThumbnail:d}=e;if(t===E.o.Story||t===E.o.Collection||t===E.o.Briefing){let e=(0,ea.G)(i),t=JSON.stringify(e?.thumbnail??null),u=JSON.stringify(a?.thumbnail??null),c=a?.thumbnail?.[0]==="generated",h=!!(c&&r instanceof Blob)||t!==u&&"null"!==t;if("null"===u&&(a={...a,thumbnail:["default"]}),!h&&!d&&(i.thumbnailUrl||i.thumbnail instanceof Blob)&&(delete i.thumbnailUrl,delete i.thumbnail),h||d){if(r instanceof Blob&&(i.thumbnail=r),!l)return;if(!c){let e=i.thumbnailUrl?await (0,S.ti)((0,ew.aU)(i.thumbnailUrl,{width:3e3,authManager:o,shouldIgnoreDPR:!0,portalHost:n}),{aspectRatio:1.5,zoom:5,quality:.8,type:"image/jpeg"}):await (0,eS.mI)(s);i.thumbnail=e}delete i.thumbnailUrl}}else void 0===r&&i.thumbnail instanceof Blob?delete i.thumbnail:r&&(i.thumbnail=r)};var ev=i(257660),eP=i(186261),eE=i(612423),eT=i(752179);let eA=e=>`smdraftrecovery_${e}`,eR=e=>{let t=eA(e);return JSON.parse(window.localStorage.getItem(t))},eC=(e,t)=>{try{{let i=eA(e),a=eR(e);if(a&&(!t||!a.downloaded))return(0,D.Hy)(a.data,`StoryMap_Draft_Recovery_${e}`),window.localStorage.setItem(i,JSON.stringify({...a,downloaded:!0})),!0}}catch{}return!1},eZ=Object.freeze({[E.o.Story]:$.Z.Action.Story_UnpublishStory,[E.o.Collection]:$.Z.Action.Collection_UnpublishCollection,[E.o.Theme]:$.Z.Action.Theme_UnpublishTheme,[E.o.Briefing]:$.Z.Action.Briefing_UnpublishBriefing,[E.o.Frame]:$.Z.Action.Frame_UnpublishFrame}),eM=Object.freeze({[E.o.Story]:$.Z.Action.Story_DuplicateStory,[E.o.Collection]:$.Z.Action.Collection_DuplicateCollection,[E.o.Theme]:$.Z.Action.Theme_DuplicateTheme,[E.o.Briefing]:$.Z.Action.Briefing_DuplicateBriefing,[E.o.Frame]:$.Z.Action.Frame_DuplicateFrame});(n=m||(m={}))[n.DRAFT_SAVE=0]="DRAFT_SAVE",n[n.PUBLISHING=1]="PUBLISHING",n[n.UNPUBLISHING=2]="UNPUBLISHING",n[n.DISCARDING_UNPUBLISHED_CHANGES=3]="DISCARDING_UNPUBLISHED_CHANGES",(l=p||(p={})).DRAFT="draft",l.PUBLISHED="published";class eN extends eT.j{static #e=this.fetchItemDraftData=async e=>{try{let t=await (0,I.jH)({itemDetails:e.itemDetails,portalHost:e.portalHost,authManager:e.authManager});if(t=await (0,eE.qm)(e,t),eN.validateItemData(e.type,t))return{itemData:t,itemDataVersion:"draft"};throw{itemData:t,itemDataVersion:"draft"}}catch(t){if((0,b.ZX)(e.itemDetails))return{itemData:await eN.fetchPublishedItemData({type:e.type,itemId:e.itemDetails.id,authManager:e.authManager,portalHost:e.portalHost,onlyReturnPublishedDataJsonResource:!0}),itemDataVersion:"published"};if(404===t.code){let t=eR(e.itemDetails.id),i=new eP.z(e.itemDetails.id,t&&t.data?t&&t.data:void 0);throw $.Z.trackEvent($.Z.Category.Error,$.Z.Action.Error_DraftDataMissing,e.trackRecoveryMode?$.Z.Name.Draft_Recovery:void 0),i}throw t}};setPendingChanges(e,t,i){this.pendingChanges.set(t,{type:e,status:i})}getPendingChangesFor(e){return this.pendingChanges.get(e)}hasPendingChanges(e){let t=Array.from(this.pendingChanges.values());e&&(t=t.filter(t=>{let{type:i}=t;return e===i}));let i=Array.from(t.values()).map(e=>{let{status:t}=e;return t}).includes(!0);return i||e||this.pendingChanges.clear(),i}constructor(e){var t;super(e),t=this,this.itemDraftDataJSON="",this.isPublishWorkflowLocked=!1,this.itemResourcesEditInfo={},this.trackThirdPartyAppEditorApp=()=>{let e=(0,H.W$)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:T.ss})[0];e&&$.Z.trackEvent($.Z.Category.ThirdParty,this.type+$.Z.Action.ThirdParty_Edited,e)},this.trackThirdPartyPubliserApp=()=>{let e=(0,H.W$)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:T.sO})[0];e&&$.Z.trackEvent($.Z.Category.ThirdParty,this.type+$.Z.Action.ThirdParty_Published,e)},this.isDataLossAllowed=!1,this.isDataRecoveryPendingReview=!1,this.pendingChanges=new Map,this.pendingChangesKey=Symbol(),this.isDraftDataFetchedFromPublishedData=!1,this.getItemPublishDate=()=>this.getItemPublishStatus()===W.PC.published&&super.getItemPublishDate(),this.setItemResourceIdsToKeep=e=>{this.itemResourceIdsToKeep=new Set(e)},this.upsertItemResource=e=>{let t=async()=>{try{return await M({...e,authManager:this.authManager,config:this.config,itemDetails:this.itemDetails,isDataLossAllowed:this.isDataLossAllowed,itemResourcesEditInfo:this.itemResourcesEditInfo})}catch(e){if(e instanceof R){if(await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed)return t();return{success:!1}}throw Error()}};return t()},this.confirmDataLossBeforeSave=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{await L({authManager:t.authManager,config:t.config,currentResourceProperties:e.currentResourceProperties,isDataLossAllowed:t.isDataLossAllowed,itemDetails:t.itemDetails,itemResourcesEditInfo:t.itemResourcesEditInfo,resourceName:e.resourceName})}catch(e){if(e instanceof R)await t.handleDataLossWarning(e.resourceProperties);else throw e}},this.addPendingItemRequest=e=>{let t=(0,P.fF)(this.pendingItemRequests).then(e);return this.pendingItemRequests=t,t},this.shareStory=e=>{let t=async()=>{let t=this.isTemplate&&(0,H.w_)(this.type)?K[this.type]:j[this.type];$.Z.trackEvent(t,$.Z.Action.Story_ShareStory,e?.access??this.itemSharingLevel.access);let i=await V({authManager:this.authManager,config:this.config,fallbackThumbnailUrl:`${location.origin}${(0,eS.Zr)(this.config.BASE_URL)}`,isDataLossAllowed:this.isDataLossAllowed,itemDetails:this.itemDetails,itemResourcesEditInfo:this.itemResourcesEditInfo,sharingLevel:e??this.itemSharingLevel,type:this.type});return this.emit("share-end",i),i};return this.addPendingItemRequest(t)},this.saveDraft=()=>{let e=async()=>{if(!this.isDataRecoveryPendingReview)try{this.emit("story-save-start"),this.setPendingChanges("save",this.pendingChangesKey,!0),this.trackThirdPartyAppEditorApp(),await this.updateDataAndDetails(0);let{draftData:e,itemDetails:t,updateResources:i}=await Y({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,itemData:this.itemData,itemDetails:this.itemDetails,itemDraftData:this.itemDraftData,isDataLossAllowed:this.isDataLossAllowed,itemResourcesEditInfo:this.itemResourcesEditInfo,itemResourceIdsToKeep:this.itemResourceIdsToKeep,storeBackup:this.storeBackup,type:this.type});this.setItemDetails(t),this.onSaveEnd(void 0,[e,t,i])}catch(e){e instanceof R&&(await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&this.saveDraft())}};return this.addPendingItemRequest(e)},this.setTopicTags=e=>{if(!e?.length){this.removeTopicTags();return}let t=(0,H.jT)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:T.L3,data:e});this.setItemDetails({...this.itemDetails,typeKeywords:t})},this.removeTopicTags=()=>{this.setItemDetails({...this.itemDetails,typeKeywords:(0,H.TQ)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:T.L3})})},this.publishStory=()=>{let e=async()=>{if(this.onPublishMethodStart(1))try{await this.emitBeforePublish(e=>this.emit("publishStatusUpdate",e)),this.emit("story-save-start"),this.setPendingChanges("publish",this.pendingChangesKey,!0);let e=this.getItemPublishStatus()===W.PC.draft;await this.updateDataAndDetails(1);let{draftData:t,itemDetails:i,updateResources:a,serverItemData:r,shareItem:s,itemDraftData:o}=await X({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,fallbackThumbnailUrl:`${location.origin}${(0,eS.Zr)(this.config.BASE_URL)}`,itemDetails:this.itemDetails,itemDraftData:this.itemDraftData,isDataLossAllowed:this.isDataLossAllowed,itemResourcesEditInfo:this.itemResourcesEditInfo,sharingLevel:this.itemSharingLevel,storeBackup:this.storeBackup,type:this.type});this.trackThirdPartyPubliserApp(),this.setItemDetails(i),this.setItemData(o),this.onSaveEnd(void 0,[t,i,a]);let n=[[t,i,a],s,r],l=(await this.authManager?.getUser()).userLicenseTypeId;await eb({type:this.type,itemDetails:this.itemDetails,isTemplate:this.isTemplate,itemData:this.itemData,firstPublish:e,licenseType:l,draftData:t,authManager:this.authManager,config:this.config}),this.onPublishMethodEnd(1,[e,null,n])}catch(e){if(e instanceof R)await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&this.publishStory();else throw this.onPublishMethodEnd(1,[!1,e]),Error(e)}};return this.addPendingItemRequest(e)},this.discardUnpublishedChanges=e=>{let t=async()=>{if(this.onPublishMethodStart(3))try{this.emit("story-save-start"),this.setPendingChanges("publish",this.pendingChangesKey,!0);let{draftData:t,itemDetails:i,updateResources:a}=await ee({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,itemData:this.itemData,itemDetails:this.itemDetails,isDataLossAllowed:this.isDataLossAllowed,isDuplicateCleanup:e,itemResourcesEditInfo:this.itemResourcesEditInfo,storeBackup:this.storeBackup,type:this.type});this.setItemDraftData(this.itemData),this.setItemDetails(i);let r=[t,i,a];this.onSaveEnd(void 0,[r]),e||$.Z.trackEvent(j[this.type],$.Z.Action.Story_DiscardUnpublishedChanges),this.onPublishMethodEnd(3,[r])}catch(e){if(e instanceof R)await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&await this.discardUnpublishedChanges();else throw this.onPublishMethodEnd(3,[null,e]),Error(e)}};return this.addPendingItemRequest(t)},this.unpublishStory=e=>{let t=async()=>{if(this.onPublishMethodStart(2))try{this.emit("story-save-start"),this.setPendingChanges("publish",this.pendingChangesKey,!0),await this.updateDataAndDetails(2,e);let{draftData:t,itemDetails:i,updateResources:a,shareItem:r,itemData:s}=await et({appVersion:this.config.APP_VERSION,authManager:this.authManager,config:this.config,fallbackThumbnailUrl:`${location.origin}${(0,eS.Zr)(this.config.BASE_URL)}`,itemDetails:this.itemDetails,itemDraftData:this.itemDraftData,isDataLossAllowed:this.isDataLossAllowed,isDuplicateCleanup:e,itemResourcesEditInfo:this.itemResourcesEditInfo,storeBackup:this.storeBackup,type:this.type,sharingLevel:el.v});this.setItemData(s),this.setItemDetails(i),this.itemSharingLevel=el.v,this.onSaveEnd(void 0,[t,i,a]);let o=[[t,i,a],r];e||$.Z.trackEvent(this.isTemplate&&(0,H.w_)(this.type)?K[this.type]:j[this.type],this.isTemplate?$.Z.Action.Builder_Template:eZ[this.type]),this.onPublishMethodEnd(2,[o])}catch(e){if(e instanceof R)await this.handleDataLossWarning(e.resourceProperties),this.isDataLossAllowed&&this.unpublishStory();else throw this.onPublishMethodEnd(2,[null,e]),Error(e)}};return this.addPendingItemRequest(t)},this.hasUnsavedChanges=async()=>this.itemDraftDataJSON!==JSON.stringify((await this.getStoryData(0)).itemData),this.setGetStoryDataMethod=e=>{this.getStoryData=e},this.setGenerateStoryItemUrlMethod=e=>{this.generateStoryItemUrl=e},this.setEmitBeforePublish=e=>{this.emitBeforePublish=e},this.setConfirmDataLossMethod=e=>{this.confirmDataLoss=e},this.setConfirmAdminAction=e=>{this.confirmAdminAction=e},this.fetchStoryBuilderData=async()=>{let e={itemId:this.itemId,authManager:this.authManager,portalHost:this.config.PORTAL_HOST},t={...e,type:this.type},i=await eN.fetchItemDetails(e);if("update"!==i.itemControl&&"admin"!==i.itemControl&&!i.origin)throw new eu.Z({type:"story-privileges-edit",itemType:this.type});if(this.setItemDetails(i),i.origin)throw new eu.Z({type:"distributed-collab-no-draft"});let a=await (0,b.mY)({itemDetails:this.itemDetails,authManager:this.authManager,excludeFavoritesGroup:!0});this.itemSharingLevel={access:this.itemDetails.access,groups:a,isUnlisted:this.itemDetails.typeKeywords?.includes(T.L7)??!1};try{let{itemData:e,itemDataVersion:t}=await eN.fetchItemDraftData({itemDetails:this.itemDetails,type:this.type,authManager:this.authManager,portalHost:this.config.PORTAL_HOST,trackRecoveryMode:!0});this.setItemDraftData(e),"published"===t&&(this.isDraftDataFetchedFromPublishedData=!0,this.setItemData(e))}catch(e){if((0,eP.T)(e))this.isDataRecoveryPendingReview=!0,this.setItemDraftData(e.recoveryDraftData);else throw e}if(await N({authManager:this.authManager,config:this.config,itemDetails:this.itemDetails,itemResourcesEditInfo:this.itemResourcesEditInfo,resourceName:"draft.json"}),this.getItemPublishStatus()!==W.PC.draft){let e=await eN.fetchPublishedItemData(t);this.setItemData(e)}},this.isStoryOwner=async()=>{let e=await this.authManager?.getUser();return e?.username===this.itemOwner},this.duplicateStory=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"draft",i=`${(0,_.Zl)(t.config.PORTAL_HOST,t.authManager)}/content/users/${t.itemOwner}/items/${t.itemId}/copy`,a=Array.isArray(e)?e:[e],r=[{mode:"draft",tag:ev.L5.DRAFT},{mode:"published",tag:ev.L5.PUBLISHED},{mode:"from-template",tag:ev.L5.FROM_TEMPLATE}].filter(e=>{let{mode:t}=e;return a.includes(t)}).map(e=>{let{tag:t}=e;return t}),s=await (0,y.WY)(i,{authentication:t.authManager,httpMethod:"POST",params:{includeResources:!0,copyPrivateResources:"draft"===e,tags:r.join(","),f:"json"}}),o=a.includes("published");$.Z.trackEvent(t.isTemplate&&(0,H.w_)(t.type)?K[t.type]:j[t.type],t.isTemplate?$.Z.Action.Builder_Template:eM[t.type],o?$.Z.Name.ItemStatistics_DuplicatePublishedItem:$.Z.Name.Builder_Common_Duplicate);let n={itemId:s.itemId,authManager:t.authManager,portalHost:t.config.PORTAL_HOST},l={maxRetries:60,delay:5e3};if(o)await (0,P.Up)(eT.j.fetchPublishedItemData,{promiseArguments:[{...n,type:t.type,onlyReturnPublishedDataJsonResource:!0}],...l});else{let e=await eN.fetchItemDetails(n);await (0,P.Up)(I.jH,{promiseArguments:[{itemDetails:e,portalHost:t.config.PORTAL_HOST,authManager:t.authManager}],...l})}return s},this.duplicateStoryCleanup=async e=>{let{titlePrefix:t,untitledItemString:i}=e,a=(0,eE.Np)(this.itemDetails,this.isDraftDataFetchedFromPublishedData),r=a.includes("from-template");a.includes("published")&&await this.discardUnpublishedChanges(!0);let s=r?"":`${t} `;if(this.type===E.o.Theme){let e=await function(e,t){let i=(0,ec.E)({stringModifier:t.titlePrefix,originalString:e.title??t.untitledItemString,maxLength:F.e4});return{...e,title:i}}(this.itemDraftData,{untitledItemString:i,titlePrefix:s});this.setItemDraftData(e)}else{let e=await this.authManager?.getUser(),t=function(e){let{itemData:t,coverOptions:i,duplicateMode:a}=e,r=a.includes("published");return t.nodes=Object.keys(t.nodes).reduce((e,a)=>{let s=t.nodes[a];if(eD(s)){let t=s;return r&&(t=function(e){if(!eD)return e;let t=e.config;if(!t?.analytics)return e;let i=structuredClone(t);return delete i.analytics,{...e,config:i}}(t)),t=function(e,t){if(!eD)return e;let i=e.data;if(!i.metaSettings||"string"!=typeof i.metaSettings.title)return e;let a=structuredClone(i.metaSettings);return a.title=(0,ec.E)({stringModifier:t,originalString:i.metaSettings.title,maxLength:eo.xP}),{...e,data:{...i,metaSettings:a}}}(t,i.titlePrefix),{...e,[a]:t}}return eI(s)?{...e,[a]:function(e,t){if(!["storycover","collection-cover"].includes(e.type))return e;let i=e.data,a=i.title,r=(0,eS.PR)(a)?t.untitledItemString:a,s=(0,ec.E)({stringModifier:t.titlePrefix,originalString:r,maxLength:eo.xP}),o=(0,eS.RZ)(t.user.firstName,t.user.lastName);return{...e,data:{...i,title:s,byline:o}}}(s,i)}:{...e,[a]:s}},{}),t}({itemData:this.itemDraftData,coverOptions:{untitledItemString:i,titlePrefix:s,user:e},duplicateMode:a});this.setItemDraftData(t)}let o=function(e,t){if("title"in e)return e.title??t;if("nodes"in e)for(let i in e.nodes){let a=e.nodes[i];if(eI(a))return a.data.title??t}return t}(this.itemDraftData,i),n=(0,ea.G)(this.itemDetails);if(n?.metaProperties?.title){let e=structuredClone(n);e.metaProperties?.title&&(e.metaProperties.title=o,n=(0,ea.M)(e,this.itemDetails))}return this.setItemDetails({...this.itemDetails,title:o,properties:n,tags:this.itemDetails.tags?.filter(e=>e!==ev.L5.DRAFT&&e!==ev.L5.PUBLISHED&&e!==ev.L5.FROM_TEMPLATE),typeKeywords:r?this.itemDetails.typeKeywords?.filter(e=>e!==T.CB):this.itemDetails.typeKeywords}),await this.unpublishStory(!0),a},this.fetchItemResource=async e=>{let{skipEditInfoTracking:t,...i}=e,a=await super.fetchItemResource(i);return t||await N({authManager:this.authManager,config:this.config,itemDetails:this.itemDetails,itemResourcesEditInfo:this.itemResourcesEditInfo,resourceName:i.resourceName}),a},this.getItemFirstPublishDate=()=>this.getItemPublishStatus()===W.PC.published&&super.getItemFirstPublishDate(),this.autosaveStory=(0,P.e2)(this.saveDraft,{debounceTime:1e3,throttleTime:1e4,confirmBeforeUnload:!0,setFnStatusBeforeUnload:()=>this.setPendingChanges,onImmediateCallback:e=>{this.removePristineTypeKeyword(),this.isPublishWorkflowLocked?e("Cancel: pending publish"):this.cancelPendingAutosave=e}}),this.onSaveEnd=(e,t,i)=>{window.removeEventListener("beforeunload",this.defaultWindowUnloadEvent),this.emit("story-save-end",e,t,i),this.setPendingChanges("save",this.pendingChangesKey,!1)},this.getPublishEventName=e=>{switch(e){case 1:return"story-publish";case 3:return"discard-unpublished-changes";default:return"story-unpublish"}},this.onPublishMethodStart=e=>!this.isPublishWorkflowLocked&&!this.isDataRecoveryPendingReview&&(this.cancelPendingAutosave?.("Cancel: Publish method started"),this.isPublishWorkflowLocked=!0,this.emit(`${this.getPublishEventName(e)}-start`),window.addEventListener("beforeunload",this.defaultWindowUnloadEvent),!0),this.onPublishMethodEnd=(e,t)=>{this.isPublishWorkflowLocked=!1,this.emit(`${this.getPublishEventName(e)}-end`,...t),this.emit("publish-method-end"),window.removeEventListener("beforeunload",this.defaultWindowUnloadEvent)},this.onDataOverwriteRejected=()=>{window.removeEventListener("beforeunload",this.defaultWindowUnloadEvent),this.emit("DATA_OVERWRITE_REJECTED")},this.getStoryData=async e=>({itemDetails:{},itemData:{root:"",nodes:{},resources:{}}}),this.generateStoryItemUrl=()=>{throw Error("Generate-url function not provided")},this.emitBeforePublish=e=>Promise.resolve(),this.updateDataAndDetails=async(e,t)=>{let i=t?{itemData:this.itemDraftData,itemDetails:this.itemDetails}:await this.getStoryData(e);if(void 0!==i){if((1===e||0===e)&&this.setItemDraftData(i.itemData),1===e||2===e||this.getItemPublishStatus()===W.PC.draft){let t={...this.itemDetails,...i.itemDetails};t.title||(t.title=(0,eE.bH)({type:this.type,dateStamp:t.created})),this.type!==E.o.Theme&&(1===e?t.url=this.generateStoryItemUrl((0,en.kN)({route:"viewer",itemId:this.itemId,itemType:this.type,isTemplate:this.isTemplate})):2===e&&(t.url=""));let a=void 0===i.shouldPushMetaToAGOItemDetails?es.R:i.shouldPushMetaToAGOItemDetails;if(await e_({type:this.type,itemDetails:t,itemProperties:i.properties,thumbnail:i.thumbnail,baseUrl:this.config.BASE_URL,authManager:this.authManager,portalHost:this.config.PORTAL_HOST,shouldPushMetaToAGOItemDetails:a,shouldForceUpdateThumbnail:i.hasShouldPushMetaToAGOItemDetailsChanged&&a}),a){let e=i.properties?.metaProperties;e?.title&&(t.title=e.title),e?.description&&(t.snippet=e.description),delete i.properties?.metaProperties,delete t.properties?.metaProperties}else delete t.title,delete t.snippet,delete t.description;i.properties&&(t.properties=(0,ea.M)(i.properties,t)),t.clearEmptyFields=!0,this.setItemDetails(t)}}else throw Error("Story data not getting updated.")},this.defaultWindowUnloadEvent=e=>{e.preventDefault(),e.returnValue=""},this.downloadDraftRecoveryFileFromConsole=()=>{eC(this.itemId)||console.error("No draft recovery file available for download.")},this.storeBackup=()=>{try{let e={timestamp:Date.now(),downloaded:!1,data:this.itemDraftData};window.localStorage.setItem(eA(this.itemId),JSON.stringify(e))}catch{}},this.handleDataLossWarning=async e=>{if(e?.editInfo&&"function"==typeof this.confirmDataLoss){if(!await this.confirmDataLoss(e.editInfo))throw this.onDataOverwriteRejected(),Error(eo.J8);this.isDataLossAllowed=!0,setTimeout(()=>{this.isDataLossAllowed=!1},5e3)}},this.removePristineTypeKeyword=()=>{this.itemDetails.typeKeywords?.includes(T.Zv)&&this.setItemDetails({...this.itemDetails,typeKeywords:this.itemDetails.typeKeywords.filter(e=>e!==T.Zv)})},window.downloadDraftRecoveryFile=this.downloadDraftRecoveryFileFromConsole}get itemDraftData(){return this._itemDraftData}set itemDraftData(e){if(this._itemDraftData)throw Error("Item draft data have already been set on the StoryItem and cannot be modified from outside of the StoryItem");this.setItemDraftData(e)}updateAppVersion(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=1===e||2===e?ed.Nf.published:ed.Nf.draft,i=(this.itemDetails.typeKeywords??[]).filter(e=>0!==e.search(t));2===e?this.setItemDetails({...this.itemDetails,typeKeywords:i}):this.setItemDetails({...this.itemDetails,typeKeywords:[...i,`${t}:${this.config.APP_VERSION}`]})}setItemPublishStatus(e){let t=q(e,this.itemDetails.typeKeywords??[]);this.setItemDetails({...this.itemDetails,typeKeywords:[...t]})}setItemFirstPublishDate(e){let t=(this.itemDetails.typeKeywords??[]).filter(e=>!e.match(ed.i1.firstPublishedDate));"remove"===e?this.setItemDetails({...this.itemDetails,typeKeywords:[...t]}):this.setItemDetails({...this.itemDetails,typeKeywords:[...this.itemDetails.typeKeywords??[],`${ed.i1.firstPublishedDate}:${new Date(e).getTime()}`]})}setItemDraftData(e){let t=er.LN.sanitize(e,{allowUndefined:!0});this._itemDraftData=t,this.itemDraftDataJSON=JSON.stringify(t)}}var eL=eN},257660:function(e,t,i){var a,r;i.d(t,{L5:function(){return a},kM:function(){return s},xx:function(){return o}});let s=["sidecar","sidecar-floating","sidecar-docked","guided-tour","guided-tour-media","guided-tour-map","explorer","explorer-grid","explorer-list"],o="/static/images/item-default-thumbnails/item.jpg";(r=a||(a={})).DRAFT="smdupdraft",r.PUBLISHED="smduppublished",r.FROM_TEMPLATE="smdupfromtemplate"},612423:function(e,t,i){i.d(t,{K3:function(){return c},KZ:function(){return p},Me:function(){return b},N8:function(){return u},Np:function(){return S},bH:function(){return d},mT:function(){return h},qm:function(){return y},so:function(){return m},yJ:function(){return g}});var a=i(293786),r=i(902183),s=i(798396),o=i(999354),n=i(863982),l=i(257660);let d=e=>{let{type:t,dateStamp:i}=e,r="number"==typeof i?i:i?.getTime()||Date.now();return`${({[a.o.Collection]:"StoryMapCollection",[a.o.Story]:"StoryMap",[a.o.Frame]:"StoryMapFrame",[a.o.Briefing]:"StoryMapBriefing",[a.o.Theme]:"Theme"})[t]} ${1e3*Math.round(r/1e3)}`},u=e=>{let t=(0,r.HL)(e);return t===a.o.Collection?s.zC.Collection:t===a.o.Briefing?s.zC.Briefing:t===a.o.Frame?s.zC.Frame:void 0},c=e=>e?e===a.o.Briefing?s.zC.Briefing:e===a.o.Collection?s.zC.Collection:e===a.o.Frame?s.zC.Frame:void 0:void 0,h=(e,t)=>(0,r.HL)(e)===t,m=e=>!!e&&l.kM.includes(e),p=async(e,t)=>{let i=await t?.getUser();if(i?.groups){for(let t of i.groups)if(t.capabilities.includes("updateitemcontrol")&&e.groups?.includes(t.id))return!0}return!1},y=async(e,t)=>{if(e.type===a.o.Collection&&t.items){let{convertToNewCollectionsDataSchema:a}=await i.e(72245).then(i.bind(i,972245));return await a(t,e.portalHost,e.config?.COLLECTION_ITEM_LIMIT||n.E5,e.authManager)}if(e.type===a.o.Frame){let{nodes:a,root:r}=t,{children:s}=a[r],n=a[s[0]],l=a[n.children[0]];if(l?.type==="timeline-slide"){let{convertToNewFrameTimelineDataSchema:a}=await i.e(407).then(i.bind(i,200407));return o.Z.trackEvent(o.Z.Category.Frame,o.Z.Action.Frame_ConvertFrameTimeline,e.itemId),a(t)}if(l?.type==="journey-place"&&"journey-slide"===a[l.children[0]].type){let{convertToNewFrameJourneyDataSchema:a}=await i.e(38817).then(i.bind(i,238817));return o.Z.trackEvent(o.Z.Category.Frame,o.Z.Action.Frame_ConvertFrameJourney,e.itemId),a(t)}}return t},f={StoryMap:"component.story.emptyTitle","SMX Item":"component.story.emptyTitle",[a.o.Story]:"component.story.emptyTitle",[a.o.Briefing]:"component.briefing.emptyTitle",[a.o.Collection]:"component.collections.emptyTitle",[a.o.Frame]:"component.frame.emptyTitle","StoryMap Theme":"component.theme.emptyTheme","SMX Theme":"component.theme.emptyTheme",[a.o.Theme]:"component.theme.emptyTheme",template:"component.template.emptyTitle"},g=(e,t)=>f[t?"template":e],b=(e,t)=>t?f[t]:f[e]||"builder.common.untitled";function S(e,t){let i=[];return e.tags?.includes(l.L5.FROM_TEMPLATE)&&(i=i.concat("from-template")),e.tags?.includes(l.L5.PUBLISHED)&&(i=i.concat("published")),!t&&e.tags?.includes(l.L5.DRAFT)&&(i=i.concat("draft")),t&&(i=i.concat("published")),0===i.length&&(i=["draft"]),i}},752179:function(e,t,i){i.d(t,{j:function(){return I}});var a=i(22699),r=i(348206),s=i(69378),o=i(293786),n=i(81052),l=i(974712),d=i(332795),u=i(820666),c=i(817239),h=i(641391),m=i(447878),p=i(902183),y=i(798396),f=i(131472),g=i(863982),b=i(422377),S=i(453846),D=i(612423);class I extends a.EventEmitter{static #e=this.validateItemData=(e,t)=>{switch(e){case o.o.Briefing:case o.o.Collection:case o.o.Frame:case o.o.Story:return t&&"string"==typeof t.root;case o.o.Theme:return t&&"object"==typeof t;default:return!1}};static #t=this.fetchItemDetails=async e=>{let t=e.authManager?e.authManager:void 0;return await (0,r.rV)(e.itemId,{authentication:t,portal:t?void 0:(0,n.Zl)(e.portalHost),signal:e.signal})};static #i=this.fetchPublishedItemData=async e=>{let t=await (0,l.L)({itemId:e.itemId,authManager:e.authManager,portalHost:e.portalHost,language:e.language,onlyReturnPublishedDataJsonResource:e.onlyReturnPublishedDataJsonResource,signal:e.signal});if(t=await (0,D.qm)(e,t),I.validateItemData(e.type,t))return t;let i=Error(`invalid json response body at ${(0,n.Zl)(e.portalHost,e.authManager)}/content/items/${e.itemId}/data. reason: Unexpected end of JSON input`);throw i.name="FetchError",i.type="invalid-json",i};constructor(e){var t;super(),t=this,this._isOrgItem=!1,this._viewerMode="view",this.preloadedItemResourceImages={},this._isTemplate=!1,this.getItemResourceUrl=(e,t)=>{let i=e.authManager||this.authManager,a=this.shouldItemResourceUseCDN(),r=e.queryParameters?Object.assign({},e.queryParameters):{};!e.skipToken&&!a&&i&&i.token&&(r.token=i.token);let s=`${e.sharingUrl??(0,n.Zl)(this.config.PORTAL_HOST)}/content/items/${t??this.itemId}/resources/${e.resourceName}${Object.keys(r).length?"?"+(0,d.qC)(r):""}`;return a&&(s=s.replace(/^https:\/\/www\.arcgis\.com/,"https://cdn.arcgis.com")),s},this.preloadItemResourceImage=(e,t)=>{let i=this.getKeyForPreloadedItemResourceImage(e,t);return new Promise(a=>{if(void 0!==this.preloadedItemResourceImages[i])a({image:this.preloadedItemResourceImages[i],key:i,fileName:e,width:t});else{let r=new Image;r.src=this.getItemResourceImageFullUrl({imageFileName:e,width:t}),r.onload=()=>{this.preloadedItemResourceImages[i]=r,a({image:r,key:i,fileName:e,width:t})},r.onerror=i=>{a({error:i.error,fileName:e,width:t})}}})},this.getSupportedTranslationLocales=()=>Object.keys(u.G(this.itemDetails)?.translations??{}),this.getOriginalStoryLocale=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"en-us";return t.itemDetails.culture??e},this.getKeyForPreloadedItemResourceImage=(e,t)=>`${e}_w${t}`,this._fetchItemResource=async e=>{let t=this.getItemResourceUrl({...e,skipToken:!0}),i=await (0,s.WY)(t,{authentication:this.authManager});return/\.json$/.test(e.resourceName)?c.LN.sanitize(i,{allowUndefined:!0}):i},this._type=e.type,this.config=e.config,this.version=e.version,e.authManager&&(this.authManager=e.authManager),this._getStoryMapUserPrivileges=e.getStoryMapUserPrivileges,e.viewerMode&&(this.viewerMode=e.viewerMode)}get isTemplate(){return this._isTemplate}get itemId(){return this._itemId}set itemId(e){this._itemId||(this._itemId=e)}get type(){return this._type}get itemOwner(){return this._itemOwner}get itemDetails(){return this._itemDetails}set itemDetails(e){if(this._itemDetails)throw Error("Item details have already been set on the StoryItem and cannot be modified from outside of the StoryItem");this.setItemDetails(e)}get itemData(){return this._itemData}set itemData(e){if(this._itemData)throw Error("Item data have already been set on the StoryItem and cannot be modified from outside of the StoryItem");this.setItemData(e)}get itemSharingLevel(){return this._itemSharingLevel?this._itemSharingLevel.access===h.eJ.PRIVATE&&this._itemSharingLevel.groups?.length&&this._itemSharingLevel.groups?.length>0?{access:h.eJ.SHARED,groups:this._itemSharingLevel.groups,isUnlisted:!1}:this._itemSharingLevel:this.itemDetails&&this.itemDetails.access?{access:this.itemDetails.access,groups:[],isUnlisted:this.itemDetails.typeKeywords?.includes(m.L7)??!1}:b.v}set itemSharingLevel(e){this._itemSharingLevel=e}get selectedTopicTagIds(){let e=(0,p.c4)(this.itemDetails);return JSON.stringify(e)!==JSON.stringify(this._selectedTopicTagIds)&&(this._selectedTopicTagIds=e),this._selectedTopicTagIds}set version(e){this._itemVersion=e}get version(){return this._itemVersion}get isOrgItem(){return this._isOrgItem}set viewerMode(e){this._viewerMode=e}get viewerMode(){return this._viewerMode}get authManager(){return this._authManager}set authManager(e){!this.itemOwner&&e&&e.username&&(this._itemOwner=e.username),this._authManager=e}get storyMapUserPrivileges(){return this._getStoryMapUserPrivileges()}getItemPublishDate(){try{let e=(0,p.W$)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:S.i1.publishedDate})[0]||(0,p.W$)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:"publish-date"})[0];if(e)return new Date(parseInt(e,10));throw Error("No published date")}catch{if("builder"===this.viewerMode)return!1;return new Date(this.itemDetails?this.itemDetails.created:Date.now())}}getItemFirstPublishDate(){try{let e=(0,p.W$)({typeKeywords:this.itemDetails.typeKeywords,typeKeywordId:S.i1.firstPublishedDate})[0];if(e)return new Date(parseInt(e,10));throw Error("No first published date")}catch{if("builder"===this.viewerMode)return!1;return new Date(this.itemDetails?this.itemDetails.created:Date.now())}}getItemPublishStatus(){return void 0===this.itemDetails?y.PC.draft:(0,p.Ot)(this.itemDetails)||y.PC.draft}getItemResourceImageFullUrl(e){let{imageFileName:t,width:i,itemId:a,shouldIgnoreDPR:r,sharingUrl:s}=e;if(!t)return"";if(t.startsWith("https://"))return t;let o=i&&(0,f.n)({width:i,fileName:t,shouldIgnoreDPR:r});return this.getItemResourceUrl({resourceName:t,authManager:void 0,sharingUrl:s,queryParameters:o?{w:o}:void 0},a)}unloadPreloadedItemResourceImage(e,t){delete this.preloadedItemResourceImages[this.getKeyForPreloadedItemResourceImage(e,t)]}shouldItemResourceUseCDN(){return"view"===this.viewerMode&&"www.arcgis.com"===this.config.PORTAL_HOST&&this.itemSharingLevel.access===h.eJ.PUBLIC}fetchItemResource(e){return this._fetchItemResource(e)}setItemDetails(e){this._itemId=e.id,this._itemOwner=e.owner,this._isTemplate=(0,p.qg)(e),this._itemDetails=e,(this._itemDetails.orgId||this._itemDetails.isOrgItem||0===(this._itemDetails.typeKeywords??[]).filter(e=>e===g.nt).length)&&(this._isOrgItem=!0)}setItemData(e){let t=c.LN.sanitize(e,{allowUndefined:!0});this._itemData=t}}t.Z=I},812943:function(e,t,i){i.d(t,{DF:function(){return u},Hz:function(){return I},Oo:function(){return p},Yy:function(){return h},bQ:function(){return g},cT:function(){return f},h8:function(){return c},u3:function(){return b}});var a=i(395486),r=i(278921),s=i(379293),o=i(798396),n=i(71635),l=i(863982),d=i(453846);let u=async e=>{let t,{blob:i,fileType:a,config:s,disallowedMimeTypes:o}=e;if(a===d.Gi.Audio||a===d.Gi.Video||a===d.Gi.ImageOrVideo||a===d.Gi.Image){if(s)t=await p({blob:i,fileType:a,config:s,disallowedMimeTypes:o});else throw Error("Config cannot be undefined")}else t=await p({blob:i,fileType:a});if(!t.isValid)throw t.details;return a===d.Gi.GeoData?await y(i):await (0,r.M4)(i)},c=async(e,t)=>{let i=t?await (0,r.JB)(t):void 0,a=i?.ext,o=["heic","heif","webp","tiff","tif"].includes(a??""),n=t&&a?.match(/(jpg|jpeg|heic|heif|webp|tiff|tif)$/i)?await S(t):void 0;if(o)return{src:e,width:0,height:0,provider:"uri",location:n};try{let{width:t,height:i}=await (0,s.pz)(e);return{src:e,width:t,height:i,provider:"uri",location:n}}catch(e){throw Error(e)}},h=(e,t)=>{if(t>l.Ry||e>l.Ry)throw o.S.MAX_FILE_SIZE_EXCEEDED},m=async e=>{let{blob:t,validMimeTypes:i,checkFileExtensionOnly:a}=e;if(a)return I(t.name,i).length>0;let s=await (0,r.JB)(t);if(!s)return!1;let{mime:o}=s;return!!i.find(e=>o===e)},p=async e=>{let t,{blob:i,fileType:a,config:r,disallowedMimeTypes:s}=e,u=[],c=[],h=[];switch((a===d.Gi.Video||a===d.Gi.Audio||a===d.Gi.ImageOrVideo||a===d.Gi.Image)&&void 0!==r&&(u=(0,n.p5)(d.Gi.Video,r,s),c=(0,n.p5)(d.Gi.Audio,r,s),h=(0,n.p5)(d.Gi.Image,r,s)),a){case d.Gi.Image:t=h;break;case d.Gi.Video:t=u;break;case d.Gi.Audio:t=c;break;case d.Gi.ImageOrVideo:t=[...h,...u];break;case d.Gi.File:t=l.KV;break;case d.Gi.GeoData:t=l.CZ;break;default:return{isValid:!1,details:o.S.INVALID_FILE_TYPE}}let p=await m({blob:i,validMimeTypes:t,checkFileExtensionOnly:a===d.Gi.GeoData}),y=a;p&&a===d.Gi.ImageOrVideo&&(y=-1!==u.findIndex(e=>e===i.type)?d.Gi.Video:d.Gi.Image);let f="image/gif"===i.type||"application/pdf"===i.type||"text/vtt"===i.type||y===d.Gi.Video||y===d.Gi.Audio?i.size>l.Tb:y===d.Gi.GeoData?i.size>l.Iv:i.size>l.WB,g="";return p?f&&(g=o.S.MAX_FILE_SIZE_EXCEEDED):g=o.S.INVALID_FILE_TYPE,{isValid:p&&!f,details:g}},y=async e=>{let t;try{t=await e.text()}catch{throw o.S.FILE_READ_ERROR}if(t?.length)return t;throw o.S.FILE_READ_ERROR},f=e=>new Promise((t,i)=>{let a=e.blob||(0,r.OP)(e.data.src),s=g(a.type);e.storyBuilder.upsertItemResource({resourceName:s,resource:a,isAdd:!0}).then(()=>{let i={provider:"item-resource",resourceId:s};e.data.width&&(i.width=e.data.width),e.data.height&&(i.height=e.data.height),e.data.name&&(i.name=e.data.name),t(i)}).catch(()=>{i()})}),g=e=>{let t=e.slice(e.indexOf("/")+1);return"svg+xml"===t&&(t="svg"),b(t)},b=e=>`${(0,a.x0)()}.${e}`,S=async e=>{try{await Promise.all([i.e(48834),i.e(58456)]).then(i.bind(i,458456));let t=await Promise.all([i.e(48834),i.e(59540)]).then(i.t.bind(i,959540,23)),a=await t.gps(e);if(a?.latitude&&a?.longitude)return{latitude:a.latitude,longitude:a.longitude};return}catch(e){return}},D=e=>RegExp(`\\.${e}$`,"i"),I=(e,t)=>{for(let i of t){let t=D(i);if(e.match(t))return i}return""}},652202:function(e,t,i){i.d(t,{F9:function(){return n},Wr:function(){return o},kr:function(){return s}});var a=i(293786),r=i(447878);let s=e=>"expressmap"===e||"thematic-map-dataset"===e||"express-image-data"===e,o=(e,t,i)=>{let r=e&&("string"==typeof e.root||i===a.o.Collection||i===a.o.Theme)?n(e):n(),o=t&&("string"==typeof t.root||i===a.o.Collection||i===a.o.Theme)?n(t):n();return{itemResourcesToUnpublish:o.itemResources.filter(e=>-1===r.itemResources.findIndex(t=>t.id===e.id)),itemResourcesToPublish:r.itemResources.filter(e=>!!s(e.type)||-1===o.itemResources.findIndex(t=>t.id===e.id)),draftItemResources:r.itemResources,publishedItemResources:o.itemResources,relatedItems:r.itemRelationships.concat(o.itemRelationships)}},n=e=>{let t=[],i=[];return e&&Object.keys(e.resources??{}).forEach(a=>{let s=e.resources[a];"image"===s.type&&"item-resource"===s.data.provider?t.push({id:s.data.resourceId,type:"image"}):"video"===s.type&&"item-resource"===s.data.provider?t.push({id:s.data.resourceId,type:"video"}):"audio"===s.type&&"item-resource"===s.data.provider?t.push({id:s.data.resourceId,type:"audio"}):"expressmap"===s.type&&l(s.data)?t.push({id:s.data.itemId,type:"expressmap"}):"thematic-map-dataset"===s.type?t.push({id:s.data.itemId,type:"thematic-map-dataset"}):"express-image-data"===s.type?t.push({id:s.data.itemId,type:"express-image-data"}):"file-item"===s.type&&"item-resource"===s.data.provider?t.push({id:s.data.resourceId,type:"file-item"}):"story-theme"===s.type&&s.data.themeItemId?i.push({type:r.t4,itemId:s.data.themeItemId}):"geo-data"===s.type&&"item-resource"===s.data.provider?t.push({id:s.data.resourceId,type:"geo-data"}):"json"===s.type&&"item-resource"===s.data.provider&&t.push({id:s.data.resourceId,type:"json"})}),{itemResources:t,itemRelationships:i}},l=e=>void 0===e.provider&&!!e.itemId},180997:function(e,t,i){i.d(t,{Q:function(){return r},r:function(){return s}});var a=i(348206);let r=e=>{let{group:t,hasItemOwnerPermission:i,allowSharingToUpdateGroups:a}=e;return!!((t.userMembership?.memberType==="admin"||t.userMembership?.memberType==="owner"||!t.isViewOnly&&t.userMembership?.memberType==="member"&&i)&&(!a&&(!t.capabilities||!t.capabilities.includes("updateitemcontrol"))||a))},s=async(e,t)=>(await (0,a.Ye)(e,{authentication:t,paging:{num:100,start:0}})).items.reduce((e,t)=>(e.push(t.id),e),[])},278921:function(e,t,i){i.d(t,{Hy:function(){return l},JB:function(){return c},M4:function(){return s},OP:function(){return o},ds:function(){return n},mD:function(){return d},mb:function(){return u}});var a=i(970826),r=i(798396);let s=e=>new Promise((t,i)=>{let a=new FileReader;a.onload=()=>{t(a.result)},a.onerror=()=>{i(r.S.FILE_READ_ERROR)},a.readAsDataURL(e)}),o=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,i=e.split(",")[0].split(":")[1].split(";")[0],a=atob(e.split(",")[1]),r=[];for(let e=0;e<a.length;e+=t){let i=a.slice(e,e+t),s=Array(i.length);for(let e=0;e<i.length;e++)s[e]=i.charCodeAt(e);let o=new Uint8Array(s);r.push(o)}return new Blob(r,{type:i})},n=e=>new Blob([JSON.stringify(e)],{type:"application/json"}),l=(e,t)=>{let i="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e)),a=document.createElement("a");a.setAttribute("href",i),a.setAttribute("download",t+".json"),document.body.appendChild(a),a.click(),a.remove()},d=(e,t)=>{if(!e||0>=e.lastIndexOf("."))return;let i=t?.split("/")[0],a=e.toLowerCase().split(".").pop();return"audio"===i&&"mp3"!==a&&"mpeg"!==a&&"wav"!==a&&"x-wav"===(a=t?.slice(t.indexOf("/")+1))&&(a="wav"),a},u=e=>e<5e5?a.VG.Common_Size_XSmall:e<1e6?a.VG.Common_Size_Small:e<5e6?a.VG.Common_Size_Medium:e<1e7?a.VG.Common_Size_Large:e<2e7?a.VG.Common_Size_XLarge:a.VG.Common_Size_XXLarge,c=async e=>{if("image/svg+xml"===e.type)return{ext:"svg",mime:"image/svg+xml"};if("text/vtt"===e.type)return{ext:"vtt",mime:"text/vtt"};let t=await e.arrayBuffer(),{fileTypeFromBuffer:a}=await Promise.all([i.e(48834),i.e(93899),i.e(24106)]).then(i.bind(i,493899)),r=await a(t);return r?"application/xml"===r.mime&&e.name&&e.name.match(/\.gpx$/i)?{ext:"gpx",mime:"application/gpx+xml"}:{ext:r.ext,mime:r.mime}:e.name.match(/\.vtt$/i)?{ext:"vtt",mime:"text/vtt"}:void 0}},844407:function(e,t,i){i.d(t,{$9:function(){return l},TJ:function(){return u},jH:function(){return c}});var a=i(348206),r=i(368667),s=i(81052),o=i(447878),n=i(902183);let l=e=>/^draft(?:_\d+)?.json$/.test(e),d=e=>(0,n.W$)({typeKeywords:e.typeKeywords,typeKeywordId:o.W2})[0]||"draft.json",u=e=>e.filter(e=>l(e.resource)).sort((e,t)=>{let i=RegExp(`${o.AY}(?<timestamp>[0-9]+).json`,"g"),a=RegExp(`${o.AY}(?<timestamp>[0-9]+).json`,"g"),r=i.exec(e.resource)?.groups?.timestamp,s=a.exec(t.resource)?.groups?.timestamp;return void 0===r?1:void 0===s?-1:Number(s)-Number(r)}),c=async e=>{let{itemDetails:t,...i}=e;try{let a=d(t);return await (0,r.Dn)({...i,itemId:e.itemDetails.id,resourceId:a})}catch(o){if((0,n.$Y)(t))return{...await (0,a.m_)(e.itemDetails.id,{authentication:e.authManager}),title:t.title,snippet:t.snippet};for(let t of u(await (0,r.vb)({authManager:e.authManager,username:e.itemDetails.owner,itemId:e.itemDetails.id,portal:(0,s.Zl)(e.portalHost,e.authManager)})))try{return await (0,r.Dn)({...i,itemId:e.itemDetails.id,resourceId:t.resource})}catch{}throw o}}},650221:function(e,t,i){i.d(t,{$J:function(){return u},_H:function(){return d},x7:function(){return l}});var a=i(298537),r=i.n(a),s=i(368667),o=i(81052),n=i(844407);let l=e=>{let{currentProps:t,newProps:i}=e;return r()({},t,i)},d="DRAFT_DATA_RESOURCE",u=async e=>{let t,{resourceName:i,itemId:a,itemOwner:r,authManager:l,portalHost:u}=e,c=await (0,s.vb)({authManager:l,username:r,itemId:a,portal:(0,o.Zl)(u,l)});return t=i===d?(0,n.TJ)(c)[0]:c.filter(e=>e.resource===i)[0],t?.properties&&JSON.parse(t?.properties)||null}},974712:function(e,t,i){i.d(t,{L:function(){return n},f:function(){return o}});var a=i(348206),r=i(81052),s=i(368667);let o="published_data.json",n=async e=>{let{itemId:t,authManager:i,portalHost:n,language:l,onlyReturnPublishedDataJsonResource:d,signal:u}=e,c=i?void 0:(0,r.Zl)(n);try{return await (0,s.Dn)({itemId:t,resourceId:l?`published_data_${l}.json`:o,portalHost:n,authManager:i,signal:u})}catch{if(!d)return await (0,a.m_)(t,{authentication:i,portal:c,signal:u})}}}}]);